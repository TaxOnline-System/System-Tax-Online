<script>
async function exportHistoryPDF() {
  try {
    const rows = await fetchAllCalculations();
    const cfg  = getExpenseConfigFromUI();
    const { jsPDF } = window.jspdf || {};

    if (!rows || !rows.length) { alert('ยังไม่มีข้อมูลประวัติ'); return; }
    if (!jsPDF || !('autoTable' in (new jsPDF()))) { alert('ไม่พบ jsPDF หรือปลั๊กอิน autoTable'); return; }

    // --- ฟอนต์ไทย ---
    await ensureThaiFont();
    const FONT = 'NotoSansThai';

    // รวมยอด
    let sumIncome=0,sumExpense=0,sumDeduct=0,sumNet=0;
    rows.forEach(r=>{
      const e = computeExpenseUsed(r, cfg);
      sumIncome += r.income||0;
      sumExpense+= e;
      sumDeduct += r.deduction||0;
      sumNet    += Math.max(0,(r.income||0)-e-(r.deduction||0));
    });
    const sumTax = thaiProgressiveTax(sumNet);

    // สร้างเอกสาร
    const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
    doc.setFont(FONT, 'normal');

    // Header
    doc.setFontSize(16);
    doc.text('สรุปประวัติและภาษีรวม (TaxOnline)', 10, 14);
    doc.setFontSize(10);
    const u = auth && auth.currentUser;
    doc.text(`ผู้ใช้: ${u ? (u.displayName || u.email) : '-'}`, 10, 20);
    doc.text(`พิมพ์เมื่อ: ${new Date().toLocaleString('th-TH')}`, 10, 26);

    // วิธีรายจ่ายรวม
    const methodLine = cfg.method==='lumpsum'
      ? `วิธีรายจ่าย: เหมาจ่าย ${cfg.percent||0}%${cfg.cap?` (เพดาน ${Number(cfg.cap).toLocaleString('th-TH')} บ.)`:''}`
      : 'วิธีรายจ่าย: ตามจริง';

    doc.setFontSize(11);
    doc.text(methodLine, 10, 32);
    doc.text(`รายได้รวม: ${sumIncome.toLocaleString('th-TH')}  รายจ่ายรวม: ${sumExpense.toLocaleString('th-TH')}  ลดหย่อนรวม: ${sumDeduct.toLocaleString('th-TH')}`, 10, 38);
    doc.text(`เงินได้สุทธิ: ${sumNet.toLocaleString('th-TH')}  ภาษีรวม (ประมาณ): ${sumTax.toLocaleString('th-TH')}`, 10, 44);

    // ตาราง
    const head = [['วันที่','รายได้','รายจ่ายใช้คำนวณ','ลดหย่อน','สุทธิ','ใบเสร็จ']];
    const body = rows.map((r) => {
      const expUsed = computeExpenseUsed(r, cfg);
      const net = Math.max(0, (r.income||0) - expUsed - (r.deduction||0));
      return [
        r.date || '',
        (r.income ?? 0).toLocaleString('th-TH'),
        expUsed.toLocaleString('th-TH'),
        (r.deduction ?? 0).toLocaleString('th-TH'),
        net.toLocaleString('th-TH'),
        (r.receipts && r.receipts.length) ? r.receipts.map((x,i)=>`ไฟล์ ${i+1}`).join(' , ') : '—'
      ];
    });

    doc.autoTable({
      head, body,
      startY: 50,
      styles: { font: FONT, fontSize: 9, cellPadding: 2 },
      headStyles: { fillColor: [243,244,246], textColor: 0, font: FONT, fontStyle: 'normal' },
      columnStyles: { 0:{cellWidth:32}, 1:{cellWidth:26}, 2:{cellWidth:32}, 3:{cellWidth:26}, 4:{cellWidth:26}, 5:{cellWidth:'auto'} },
      didDrawPage: () => {
        const pageCount = doc.internal.getNumberOfPages();
        const str = `หน้า ${doc.internal.getCurrentPageInfo().pageNumber} / ${pageCount}`;
        doc.setFont(FONT, 'normal');
        doc.setFontSize(9);
        doc.text(str, 200 - doc.getTextWidth(str) - 10, 291);
      }
    });

    // ลิงก์ใบเสร็จ (แสดง label สั้น + คลิกได้)
    let y = doc.lastAutoTable.finalY + 6;
    const links = [];
    rows.forEach((r, idx) => {
      (r.receipts || []).forEach((x, i) => {
        if (x.webViewLink) links.push({ label: `แถว ${idx + 1} → ไฟล์ ${i + 1}`, url: x.webViewLink });
      });
    });

    if (links.length) {
      doc.setFont(FONT, 'normal');
      doc.setFontSize(11);
      doc.text('ลิงก์ใบเสร็จ (คลิกได้):', 10, y);
      y += 6;
      doc.setFontSize(10);

      const left = 10, step = 6;
      for (const item of links) {
        doc.textWithLink(item.label, left, y, { url: item.url });
        y += step;
        if (y > 280) { doc.addPage(); doc.setFont(FONT,'normal'); y = 14; }
      }
    }

    doc.save('taxonline_summary.pdf');
  } catch (e) {
    console.error(e);
    alert(e.message || e);
  }
}
</script>
