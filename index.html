<script>
/* =========================================================================
   TaxOnline: Advanced Theme Customizer (compatible with Drive version)
   - ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏™‡∏µ ‡∏ü‡∏≠‡∏ô‡∏ï‡πå ‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive) ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ
   - ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà Firestore: site_settings/default
   - ‡πÉ‡∏ä‡πâ ensureDriveToken() / driveAccessToken ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
   - ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ADMIN_UIDS ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ‚Äú‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° üé® ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‚Äù
   ========================================================================= */
(function(){
  // ---- ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡πÉ‡∏™‡πà UID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡πÑ‡∏î‡πâ) ----
  const ADMIN_UIDS = ['oSPrvjRwNaVV4KQgbzOi3Re4Agm1'];

  const SETTINGS_DOC = { col: 'site_settings', id: 'default' };

  // ========= Utilities =========
  const $q = s => document.querySelector(s);
  function createEl(tag, attrs={}, children=[]) {
    const el = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k==='class') el.className = v;
      else if (k==='style') el.style.cssText = v;
      else el.setAttribute(k,v);
    });
    (Array.isArray(children)?children:[children]).forEach(c=>{
      if (c==null) return;
      if (typeof c==='string') el.appendChild(document.createTextNode(c));
      else el.appendChild(c);
    });
    return el;
  }

  // ========= Drive helpers (‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤ ensureDriveToken() ‡πÅ‡∏•‡∏∞ driveAccessToken ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) =========
  async function getOrCreateDriveAssetsFolder() {
    if (typeof ensureDriveToken !== 'function') throw new Error('ensureDriveToken() not found (‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô)');
    await ensureDriveToken();
    const q = "name='TaxOnline Assets' and mimeType='application/vnd.google-apps.folder' and trashed=false";
    const search = await fetch(
      'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(q) + '&fields=files(id,webViewLink)',
      { headers: { 'Authorization': 'Bearer ' + (window.driveAccessToken || '') } }
    );
    if (search.ok) {
      const j = await search.json();
      if (j.files && j.files.length) return { id: j.files[0].id, webViewLink: j.files[0].webViewLink };
    }
    // create
    const res = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,webViewLink', {
      method:'POST',
      headers:{ 'Authorization':'Bearer '+(window.driveAccessToken||''), 'Content-Type':'application/json' },
      body: JSON.stringify({ name:'TaxOnline Assets', mimeType:'application/vnd.google-apps.folder' })
    });
    if (!res.ok) throw new Error('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Assets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const d = await res.json();
    return { id: d.id, webViewLink: d.webViewLink };
  }

  async function uploadLogoToDrive(file) {
    if (!file) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ');
    if (typeof ensureDriveToken !== 'function') throw new Error('ensureDriveToken() not found');
    await ensureDriveToken();
    const parent = await getOrCreateDriveAssetsFolder();
    const meta = { name:file.name, mimeType:file.type||'application/octet-stream', parents:[parent.id] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(meta)], { type:'application/json' }));
    form.append('file', file);
    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
      method:'POST', headers:{ 'Authorization':'Bearer '+(window.driveAccessToken||'') }, body: form
    });
    if (!res.ok) throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    const j = await res.json();
    return { driveFileId: j.id, webViewLink: j.webViewLink, name: file.name, mimeType: file.type||null };
  }

  // ========= State =========
  const state = {
    loaded: false,
    values: {
      brandTitle: '',
      welcomeTitle: '',
      welcomeSubtext: '',
      primaryColor: '#2563eb',
      accentColor:  '#f59e0b',
      buttonRadius: 12,
      darkDefault: false,
      fontUrl: '',
      fontCssFamily: 'system-ui',
      // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á
      hideWelcome: false,
      hideProfile: false,
      hideCalculator: false,
      hideHistory: false,
      // ‡πÇ‡∏•‡πÇ‡∏Å‡πâ
      logo: null // {driveFileId, webViewLink, name, mimeType}
    }
  };

  // ========= Apply theme to page =========
  function ensureLogoSlot() {
    let slot = document.getElementById('logoSlot');
    if (slot) return slot;
    const hdr = document.querySelector('header .max-w-6xl .flex.items-center');
    if (!hdr) return null;
    slot = createEl('div', { id:'logoSlot', class:'flex items-center gap-2' });
    const img = createEl('img', { id:'siteLogo', alt:'Logo', class:'h-8 w-8 rounded-lg hidden' });
    slot.appendChild(img);
    const h1 = hdr.querySelector('h1');
    if (h1) { hdr.insertBefore(slot, h1); slot.appendChild(h1); } else { hdr.prepend(slot); }
    return slot;
  }

  function injectFont(url) {
    if (!url) return;
    let link = document.getElementById('customFontLink');
    if (!link) { link = document.createElement('link'); link.id='customFontLink'; link.rel='stylesheet'; document.head.appendChild(link); }
    link.href = url;
  }

  function applySettings(v) {
    // font
    if (v.fontUrl) injectFont(v.fontUrl);
    document.documentElement.style.setProperty('--tx-font', v.fontCssFamily || 'system-ui');
    document.body.style.fontFamily = 'var(--tx-font)';

    // colors
    document.documentElement.style.setProperty('--tx-primary', v.primaryColor || '#2563eb');
    document.documentElement.style.setProperty('--tx-accent',  v.accentColor  || '#f59e0b');

    // buttons (‡∏´‡∏•‡∏±‡∏Å)
    ['#welcomeSection [data-nav="calculator"]', '#welcomeLoginBtn', '#taxForm button[type="submit"]', '#driveConnectBtn']
      .forEach(sel=>{
        const el = $q(sel); if (!el) return;
        el.style.backgroundColor = 'var(--tx-primary)';
        el.style.borderColor     = 'var(--tx-primary)';
        el.style.color           = '#fff';
        el.style.borderRadius    = (v.buttonRadius||12)+'px';
      });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≠‡∏á (history toolbar)
    ['#downloadCsvBtn','#downloadPdfBtn','#openDriveFolderBtn'].forEach(sel=>{
      const el = $q(sel); if (!el) return;
      el.style.backgroundColor = 'var(--tx-accent)'; el.style.color = '#1f2937';
      el.style.borderRadius = (v.buttonRadius||12)+'px';
    });

    // dark default
    if (v.darkDefault) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');

    // texts
    if (v.brandTitle)   { const h=$q('header h1'); if (h) h.textContent = v.brandTitle; }
    if (v.welcomeTitle) { const h=$q('#welcomeSection h2'); if (h) h.textContent = v.welcomeTitle; }
    if (v.welcomeSubtext){ const p=$q('#welcomeSection p'); if (p) p.textContent = v.welcomeSubtext; }

    // logo
    const slot = ensureLogoSlot();
    const img = slot ? slot.querySelector('#siteLogo') : null;
    if (img) {
      if (v.logo && v.logo.webViewLink) { img.src = v.logo.webViewLink; img.classList.remove('hidden'); }
      else { img.classList.add('hidden'); img.removeAttribute('src'); }
    }

    // visibility
    [
      {key:'hideWelcome',    sel:'#welcomeSection'},
      {key:'hideProfile',    sel:'#profileSection'},
      {key:'hideCalculator', sel:'#calculatorSection'},
      {key:'hideHistory',    sel:'#historySection'}
    ].forEach(m=>{
      const el = $q(m.sel); if (!el) return;
      el.style.display = v[m.key] ? 'none' : '';
    });
  }

  // ========= Firestore I/O =========
  async function loadSettings() {
    try {
      const ref = firebase.firestore().collection(SETTINGS_DOC.col).doc(SETTINGS_DOC.id);
      const snap = await ref.get();
      if (snap.exists) {
        state.values = Object.assign(state.values, snap.data() || {});
      } else {
        // defaults from current page
        state.values.brandTitle   = ($q('header h1')?.textContent || 'TaxOnline').trim();
        state.values.welcomeTitle = ($q('#welcomeSection h2')?.textContent || '').trim();
        state.values.welcomeSubtext = ($q('#welcomeSection p')?.textContent || '').trim();
      }
      applySettings(state.values);
      state.loaded = true;
    } catch (e) { console.error('load settings failed:', e); }
  }

  async function saveSettings(values) {
    const user = firebase.auth().currentUser;
    if (!user) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô (‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå)
    const isAdmin = !!(ADMIN_UIDS && ADMIN_UIDS.includes(user.uid));
    if (!isAdmin) throw new Error('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á');

    const payload = Object.assign({}, values, {
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: user.uid
    });
    await firebase.firestore().collection(SETTINGS_DOC.col).doc(SETTINGS_DOC.id).set(payload, { merge:true });
    state.values = Object.assign(state.values, values);
    applySettings(state.values);
  }

  // ========= UI (floating button + panel) =========
  function mountUI(){
    // FAB
    const fab = createEl('button', {
      id:'advCustomizeFab', type:'button',
      class:'fixed z-50 right-4 bottom-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full shadow-lg'
    }, 'üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°');
    document.body.appendChild(fab);

    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á FAB ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    firebase.auth().onAuthStateChanged((u)=>{
      const isAdmin = !!(u && ADMIN_UIDS && ADMIN_UIDS.includes(u.uid));
      fab.style.display = isAdmin ? '' : 'none';
    });

    // overlay
    const overlay = createEl('div', { id:'advCustomizeOverlay', class:'fixed inset-0 z-50 hidden', style:'background:rgba(0,0,0,.45)' });
    // ‡∏Å‡∏±‡∏ô scroll/backdrop
    ['wheel','touchmove'].forEach(evt=> overlay.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false}));
    const panel = createEl('div', { class:'absolute right-0 top-0 h-full w-full sm:w-[480px] bg-white shadow-2xl p-5 overflow-auto' });
    panel.addEventListener('click', e=> e.stopPropagation(), true);
    overlay.addEventListener('click', ()=> { overlay.classList.add('hidden'); document.body.style.overflow=''; });
    panel.setAttribute('tabindex','-1');
    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    // content
    panel.appendChild(createEl('h3', { class:'text-xl font-semibold mb-1 text-indigo-600' }, '‡∏õ‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á'));
    panel.appendChild(createEl('p',  { class:'text-xs text-gray-500 mb-4' }, '‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏™‡∏µ ‡∏ü‡∏≠‡∏ô‡∏ï‡πå ‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'));

    const form = createEl('form', { class:'space-y-4', novalidate:true });
    form.innerHTML = `
      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</legend>
        <label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö/‡πÇ‡∏•‡πÇ‡∏Å‡πâ (Header)</label>
        <input type="text" id="adv_brandTitle" class="w-full p-2 border rounded mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô TaxOnline">
        <label class="block text-sm mb-1">‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
        <input type="text" id="adv_welcomeTitle" class="w-full p-2 border rounded mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏á‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ!">
        <label class="block text-sm mb-1">‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
        <textarea id="adv_welcomeSubtext" rows="3" class="w-full p-2 border rounded" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå"></textarea>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏ò‡∏µ‡∏°‡∏™‡∏µ & ‡∏õ‡∏∏‡πà‡∏°</legend>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å (Primary)</label>
            <input type="color" id="adv_primaryColor" class="w-full h-10 p-0 border rounded" value="#2563eb">
          </div>
          <div>
            <label class="block text-sm mb-1">‡∏™‡∏µ‡∏£‡∏≠‡∏á (Accent)</label>
            <input type="color" id="adv_accentColor" class="w-full h-10 p-0 border rounded" value="#f59e0b">
          </div>
        </div>
        <label class="block text-sm mt-3">‡∏°‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏° (px)</label>
        <input type="range" id="adv_buttonRadius" min="0" max="24" step="1" value="12" class="w-full">
        <div class="text-xs text-gray-500 mt-1">‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="radiusVal">12</span>px</div>
        <label class="inline-flex items-center gap-2 mt-3 cursor-pointer">
          <input type="checkbox" id="adv_darkDefault" class="form-checkbox"> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î (Dark by default)
        </label>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏ü‡∏≠‡∏ô‡∏ï‡πå</legend>
        <label class="block text-sm mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡πá‡∏ß</label>
        <select id="adv_fontQuick" class="w-full p-2 border rounded mb-2">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap","family":"Sarabun, sans-serif"}'>Sarabun (‡πÑ‡∏ó‡∏¢)</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap","family":"Prompt, sans-serif"}'>Prompt (‡πÑ‡∏ó‡∏¢)</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600&display=swap","family":"Noto Sans Thai, sans-serif"}'>Noto Sans Thai</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap","family":"Inter, system-ui, sans-serif"}'>Inter</option>
        </select>
        <div class="grid grid-cols-1 gap-2">
          <div>
            <label class="block text-sm mb-1">Google Fonts / CSS URL</label>
            <input type="url" id="adv_fontUrl" class="w-full p-2 border rounded" placeholder="https://fonts.googleapis.com/...">
          </div>
          <div>
            <label class="block text-sm mb-1">font-family (CSS)</label>
            <input type="text" id="adv_fontCssFamily" class="w-full p-2 border rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô 'Sarabun, sans-serif'">
          </div>
        </div>
        <div class="text-xs text-gray-500 mt-2">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL/‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏≠‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ</div>
        <button type="button" id="adv_tryFont" class="mt-2 px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡πÇ‡∏•‡πÇ‡∏Å‡πâ</legend>
        <div class="flex items-center gap-3">
          <input type="file" id="adv_logoFile" accept="image/*" class="text-sm">
          <button type="button" id="adv_uploadLogo" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Drive</button>
        </div>
        <div id="adv_logoPreview" class="mt-2 text-sm text-gray-500"></div>
        <div class="text-xs text-gray-500 mt-1">* ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå "TaxOnline Assets" ‡∏ö‡∏ô Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ</legend>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideWelcome"> ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideProfile"> ‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideCalculator"> ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideHistory"> ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</label>
        </div>
      </fieldset>

      <div class="flex items-center justify-between pt-2">
        <button type="button" id="adv_preview" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded">‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        <div class="space-x-2">
          <button type="button" id="adv_close" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded">‡∏õ‡∏¥‡∏î</button>
          <button type="submit" id="adv_save" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
      <p id="adv_msg" class="text-xs text-gray-500 mt-1"></p>
    `;
    panel.appendChild(form);

    // ‡∏Å‡∏±‡∏ô submit ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ + ‡∏Å‡∏±‡∏ô Enter ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    form.addEventListener('submit', e => { e.preventDefault(); e.stopPropagation(); });
    form.addEventListener('keydown', e=>{ if (e.key==='Enter' && e.target.tagName==='INPUT') e.preventDefault(); });

    // Prefill
    function fillForm(v){
      document.getElementById('adv_brandTitle').value    = v.brandTitle   || ($q('header h1')?.textContent || 'TaxOnline');
      document.getElementById('adv_welcomeTitle').value  = v.welcomeTitle || ($q('#welcomeSection h2')?.textContent || '');
      document.getElementById('adv_welcomeSubtext').value= v.welcomeSubtext || ($q('#welcomeSection p')?.textContent || '');
      document.getElementById('adv_primaryColor').value  = v.primaryColor || '#2563eb';
      document.getElementById('adv_accentColor').value   = v.accentColor  || '#f59e0b';
      document.getElementById('adv_buttonRadius').value  = v.buttonRadius ?? 12;
      document.getElementById('radiusVal').textContent   = v.buttonRadius ?? 12;
      document.getElementById('adv_darkDefault').checked = !!v.darkDefault;
      document.getElementById('adv_fontUrl').value       = v.fontUrl || '';
      document.getElementById('adv_fontCssFamily').value = v.fontCssFamily || 'system-ui';
      document.getElementById('adv_hideWelcome').checked    = !!v.hideWelcome;
      document.getElementById('adv_hideProfile').checked    = !!v.hideProfile;
      document.getElementById('adv_hideCalculator').checked = !!v.hideCalculator;
      document.getElementById('adv_hideHistory').checked    = !!v.hideHistory;

      const prev = document.getElementById('adv_logoPreview');
      if (v.logo && v.logo.webViewLink) {
        prev.innerHTML = `<a href="${v.logo.webViewLink}" target="_blank" rel="noopener" class="text-blue-600 underline">‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${v.logo.name||'‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå'}</a>`;
      } else prev.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏•‡πÇ‡∏Å‡πâ';
    }

    // events
    document.getElementById('adv_tryFont').addEventListener('click', ()=>{
      const url = document.getElementById('adv_fontUrl').value.trim();
      const fam = document.getElementById('adv_fontCssFamily').value.trim() || 'system-ui';
      applySettings(Object.assign({}, state.values, { fontUrl:url, fontCssFamily:fam }));
      document.getElementById('adv_msg').textContent = '‡∏•‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
    });

    document.getElementById('adv_uploadLogo').addEventListener('click', async ()=>{
      const f = document.getElementById('adv_logoFile').files[0];
      if (!f) { alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const msg = document.getElementById('adv_msg');
      try {
        msg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ...';
        const res = await uploadLogoToDrive(f);
        state.values.logo = res;
        applySettings(state.values);
        const prev = document.getElementById('adv_logoPreview');
        prev.innerHTML = `<a href="${res.webViewLink}" target="_blank" rel="noopener" class="text-blue-600 underline">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${res.name}</a>`;
        msg.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")';
      } catch(e){ msg.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (e.message||e); }
    });

    document.getElementById('adv_preview').addEventListener('click', ()=>{
      applySettings(Object.assign({}, state.values, collectValues()));
      document.getElementById('adv_msg').textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
    });

    document.getElementById('adv_save').addEventListener('click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const msg = document.getElementById('adv_msg');
      try {
        await saveSettings(collectValues());
        msg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî'; msg.className='text-xs text-green-600';
        overlay.classList.add('hidden'); document.body.style.overflow='';
      } catch(err){ msg.textContent = (err.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); msg.className='text-xs text-red-600'; }
    });

    // open/close
    fab.addEventListener('click', ()=>{
      const user = firebase.auth().currentUser;
      if (!user) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const isAdmin = !!(ADMIN_UIDS && ADMIN_UIDS.includes(user.uid));
      if (!isAdmin) { alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á'); return; }
      fillForm(state.values);
      overlay.classList.remove('hidden'); document.body.style.overflow='hidden';
    });
    document.getElementById('adv_close').addEventListener('click', ()=>{ overlay.classList.add('hidden'); document.body.style.overflow=''; });

    // quick fonts
    document.getElementById('adv_fontQuick').addEventListener('change', e=>{
      const val = e.target.value; if (!val) return;
      try {
        const o = JSON.parse(val);
        document.getElementById('adv_fontUrl').value = o.url || '';
        document.getElementById('adv_fontCssFamily').value = o.family || '';
      } catch {}
    });

    function collectValues(){
      return {
        brandTitle: document.getElementById('adv_brandTitle').value.trim(),
        welcomeTitle: document.getElementById('adv_welcomeTitle').value.trim(),
        welcomeSubtext: document.getElementById('adv_welcomeSubtext').value.trim(),
        primaryColor: document.getElementById('adv_primaryColor').value,
        accentColor:  document.getElementById('adv_accentColor').value,
        buttonRadius: parseInt(document.getElementById('adv_buttonRadius').value||'12',10),
        darkDefault:  document.getElementById('adv_darkDefault').checked,
        fontUrl:      document.getElementById('adv_fontUrl').value.trim(),
        fontCssFamily:document.getElementById('adv_fontCssFamily').value.trim()||'system-ui',
        hideWelcome:    document.getElementById('adv_hideWelcome').checked,
        hideProfile:    document.getElementById('adv_hideProfile').checked,
        hideCalculator: document.getElementById('adv_hideCalculator').checked,
        hideHistory:    document.getElementById('adv_hideHistory').checked,
        logo: state.values.logo || null
      };
    }
  }

  // ========= boot =========
  const boot = ()=>{ loadSettings().then(mountUI); };
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‚Üí ‡∏î‡∏∂‡∏á‡∏ò‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  firebase.auth().onAuthStateChanged(()=>{ if (state.loaded) loadSettings(); });
})();
</script>
