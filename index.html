<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TaxOnline (Drive) - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ + ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏õ Google Drive</title>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF + autoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Google Identity Services (OAuth 2.0 for Drive) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body{background:linear-gradient(-45deg,#e0c3fc,#8ec5fc,#fbc2eb,#a1c4fd);background-size:400% 400%;animation:gradientBG 15s ease infinite}
  @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .fade-in{animation:fadeIn .7s ease-in}@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
  #splash{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:1;transition:opacity .8s ease}
  .splash-spinner{width:60px;height:60px;border:8px solid transparent;border-top-color:#ec4899;border-radius:50%;animation:spin 1.4s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .nav-link{display:inline-block;margin:.25rem .4rem}
</style>
</head>
<body class="font-sans">

<!-- Splash -->
<div id="splash">
  <div class="splash-spinner"></div>
  <h2 class="text-xl font-semibold text-pink-600 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</h2>
</div>

<!-- Header -->
<header class="bg-white shadow p-4 fixed w-full z-30 top-0">
  <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center">
    <div class="flex items-center gap-3 mb-2 sm:mb-0">
      <h1 class="text-2xl font-bold text-pink-600">TaxOnline</h1>
      <span id="userGreeting" class="text-sm text-gray-600 hidden">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‚Ä¶</span>
    </div>
    <nav class="text-center sm:text-right">
      <button class="nav-link text-pink-600 hover:underline font-semibold" data-nav="welcome">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="calculator">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
      <button id="loginNav" class="nav-link text-blue-600 hover:underline font-semibold" data-nav="auth">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button id="logoutBtn" class="nav-link text-red-600 hover:underline hidden">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </nav>
  </div>
</header>

<!-- Time + Drive status -->
<div class="fixed top-20 sm:top-4 left-4 z-50 bg-white text-sm text-gray-700 px-3 py-1 rounded shadow">
  <span id="datetime">--:--</span>
</div>
<div class="fixed top-20 sm:top-4 right-4 z-50 flex gap-2">
  <button id="driveConnectBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm font-medium">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive</button>
  <span id="driveStatus" class="bg-white text-gray-700 px-3 py-2 rounded shadow text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
</div>

<div class="pt-28 pb-16">

  <!-- Welcome -->
  <section id="welcomeSection" class="fade-in text-center px-6">
    <h2 class="text-3xl sm:text-4xl font-bold text-pink-700 mb-4">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏á‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ!</h2>
    <p class="text-gray-700 text-base sm:text-lg max-w-2xl mx-auto">
      ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ç‡∏∂‡πâ‡∏ô <b>Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á</b> (‡∏ü‡∏£‡∏µ) ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Firestore ‚Äî ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ô‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏†‡∏≤‡∏©‡∏µ
    </p>
    <div class="mt-6 flex items-center justify-center gap-3 flex-wrap">
      <button class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="calculator">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏¢</button>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="auth" id="welcomeLoginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
    </div>
  </section>

  <!-- Auth -->
  <section id="authSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl">
      <h2 class="text-2xl font-bold text-center text-pink-600 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

      <div class="flex justify-center space-x-4 mb-6">
        <button id="loginTab" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button id="signupTab" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </div>

      <!-- Login -->
      <form id="loginForm" class="space-y-4 hidden">
        <input type="email" id="loginEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <input type="password" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>

      <!-- Signup -->
      <form id="signupForm" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
          <input type="text" id="signupFirstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
          <input type="text" id="signupLastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        </div>
        <input type="email" id="signupEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <input type="password" id="signupPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold" type="submit">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </form>

      <div class="mt-6 border-t pt-4">
        <button id="googleSignInBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google (Firebase Auth)
        </button>
      </div>

      <p id="authMessage" class="text-red-500 text-center mt-4 text-sm"></p>
    </div>
  </section>

  <!-- Profile -->
  <section id="profileSection" class="hidden fade-in px-4">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-2xl font-semibold text-pink-600 mb-4">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <form id="profileForm" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700">‡∏ä‡∏∑‡πà‡∏≠</label>
            <input id="profileFirstName" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
          <div>
            <label class="block text-sm text-gray-700">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="profileLastName" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="profileEmail" type="email" class="w-full p-2 border rounded-lg" disabled/>
          </div>
          <div>
            <label class="block text-sm text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
            <input id="profilePhone" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
          <textarea id="profileAddress" rows="3" class="w-full p-2 border rounded-lg"></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
          <button type="button" id="reloadProfile" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <p id="profileMsg" class="text-sm mt-2"></p>
      </form>
    </div>
  </section>

  <!-- Calculator -->
  <section id="calculatorSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
      <h3 class="text-xl sm:text-2xl font-semibold text-center text-blue-600 mb-4">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</h3>
      <form class="space-y-4" id="taxForm">
        <div>
          <label class="block text-sm font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="income" class="w-full p-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="expense" class="w-full p-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800">‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="deduction" value="60000" class="w-full p-2 border rounded-lg"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-800">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏≠‡∏±‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</label>
          <input type="file" id="receiptUpload" accept="image/*,.pdf" multiple
                 class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
          <p class="mt-1 text-xs text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, PDF (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</p>
          <div id="fileInfo" class="mt-2 text-sm text-gray-700"></div>
          <div id="previewArea" class="mt-2 grid grid-cols-3 gap-2"></div>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</button>
      </form>
      <div class="mt-6"><canvas id="taxPieChart"></canvas></div>
      <p id="calcMsg" class="text-sm mt-3"></p>
    </div>
  </section>

  <!-- History -->
  <section id="historySection" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-semibold text-pink-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
        <div class="flex gap-2">
          <button id="refreshHistory" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button id="downloadCsvBtn" class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
          <button id="downloadPdfBtn" class="px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ PDF</button>
          <button id="openDriveFolderBtn" class="px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Drive</button>
        </div>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left bg-gray-50">
              <th class="px-3 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="px-3 py-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
              <th class="px-3 py-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
              <th class="px-3 py-2">‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô</th>
              <th class="px-3 py-2">‡∏†‡∏≤‡∏©‡∏µ</th>
              <th class="px-3 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <p id="historyMsg" class="text-sm mt-3"></p>
    </div>
  </section>

</div>

<footer class="bg-white p-4 text-center text-sm text-gray-500">
  &copy; 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ ¬∑ ‡πÉ‡∏ä‡πâ Google Drive API (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Firebase Storage)
</footer>

<script>
/* =========================
   Firebase Init
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBl-j4STHVQ80VNM6mPl80-55BHk4nEyZk",
  authDomain: "tax-online-6afdd.firebaseapp.com",
  projectId: "tax-online-6afdd",
  appId: "1:959276043439:web:f358ce055687efea5d185a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* =========================
   Google Drive OAuth (GIS)
   ========================= */
const GOOGLE_OAUTH_CLIENT_ID = "959276043439-rpc16dfdslna3ndjijicg0gehu8klp93.apps.googleusercontent.com";
const DRIVE_SCOPES = "https://www.googleapis.com/auth/drive.file";
let driveTokenClient = null;
let driveAccessToken = null;
let driveTokenExpiry = 0;

function setDriveStatus(msg, ok=false){
  const el = document.getElementById('driveStatus');
  if (!el) return;
  el.textContent = msg;
  el.className = ok ? "bg-green-100 text-green-800 px-3 py-2 rounded shadow text-sm"
                    : "bg-white text-gray-700 px-3 py-2 rounded shadow text-sm";
}

async function connectDrive(){
  if (!window.google || !google.accounts || !google.accounts.oauth2) {
    alert('‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Google OAuth ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); return;
  }
  if (!driveTokenClient) {
    driveTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_OAUTH_CLIENT_ID,
      scope: DRIVE_SCOPES,
      callback: (resp) => {
        if (resp && resp.access_token) {
          driveAccessToken = resp.access_token;
          driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
          setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÅ‡∏•‡πâ‡∏ß', true);
        } else {
          setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      }
    });
  }
  driveTokenClient.requestAccessToken({ prompt: 'consent' });
}

async function ensureDriveToken(){
  if (driveAccessToken && Date.now() < driveTokenExpiry - 5000) return driveAccessToken;
  if (!driveTokenClient) {
    driveTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_OAUTH_CLIENT_ID,
      scope: DRIVE_SCOPES,
      callback: (resp) => {
        if (resp && resp.access_token) {
          driveAccessToken = resp.access_token;
          driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
          setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÅ‡∏•‡πâ‡∏ß', true);
        }
      }
    });
  }
  return new Promise((resolve, reject) => {
    driveTokenClient.callback = (resp) => {
      if (resp && resp.access_token) {
        driveAccessToken = resp.access_token;
        driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
        setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÅ‡∏•‡πâ‡∏ß', true);
        resolve(driveAccessToken);
      } else {
        setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        reject(new Error('no access token'));
      }
    };
    driveTokenClient.requestAccessToken({ prompt: '' });
  });
}

// ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
async function getOrCreateDriveFolder(){
  const cacheKey = 'taxonline_drive_folder';
  const cached = localStorage.getItem(cacheKey);
  if (cached) return JSON.parse(cached);

  await ensureDriveToken();

  const searchRes = await fetch(
    'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent("name='TaxOnline Receipts' and mimeType='application/vnd.google-apps.folder' and trashed=false") + '&fields=files(id,webViewLink)',
    { headers: { 'Authorization': 'Bearer ' + driveAccessToken } }
  );
  if (searchRes.ok) {
    const j = await searchRes.json();
    if (j.files && j.files.length > 0) {
      const found = { id: j.files[0].id, webViewLink: j.files[0].webViewLink };
      localStorage.setItem(cacheKey, JSON.stringify(found));
      return found;
    }
  }

  const createRes = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,webViewLink', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + driveAccessToken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name: 'TaxOnline Receipts', mimeType: 'application/vnd.google-apps.folder' })
  });
  if (!createRes.ok) {
    const t = await createRes.text();
    throw new Error('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Drive ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + t);
  }
  const data = await createRes.json();
  const out = { id: data.id, webViewLink: data.webViewLink };
  localStorage.setItem(cacheKey, JSON.stringify(out));
  return out;
}

// ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Drive
async function uploadFilesToDrive(files, parentInfo){
  await ensureDriveToken();
  const results = [];
  const parentId = parentInfo?.id;

  for (const file of Array.from(files || [])) {
    const metadata = {
      name: file.name,
      mimeType: file.type || 'application/octet-stream',
      parents: parentId ? [parentId] : undefined
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    const url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink';
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + driveAccessToken },
      body: form
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Drive ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + t);
    }
    const json = await res.json();
    results.push({
      name: file.name,
      size: file.size || null,
      mimeType: file.type || null,
      driveFileId: json.id,
      webViewLink: json.webViewLink
    });
  }
  return results;
}

/* =========================
   UI & Auth
   ========================= */
const sections = {
  welcome: document.getElementById('welcomeSection'),
  auth: document.getElementById('authSection'),
  profile: document.getElementById('profileSection'),
  calculator: document.getElementById('calculatorSection'),
  history: document.getElementById('historySection')
};
const userGreeting = document.getElementById('userGreeting');
const loginNav = document.getElementById('loginNav');
const logoutBtn = document.getElementById('logoutBtn');
const historyBody = document.getElementById('historyBody');
const historyMsg = document.getElementById('historyMsg');
const profileMsg = document.getElementById('profileMsg');
const calcMsg = document.getElementById('calcMsg');

function showOnly(sectionKey){
  Object.keys(sections).forEach(k=>{
    sections[k].classList.toggle('hidden', k!==sectionKey);
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.querySelectorAll('[data-nav]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.getAttribute('data-nav');
    if (target==='calculator' || target==='history' || target==='profile') {
      if (!auth.currentUser) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); showOnly('auth'); return; }
    }
    if (target==='history') loadHistory();
    if (target==='profile') loadProfile();
    showOnly(target);
  });
});

document.getElementById('driveConnectBtn').addEventListener('click', connectDrive);

// Clock
function updateDateTime(){
  const now = new Date();
  const timeStr = now.toLocaleTimeString('th-TH');
  const dateStr = now.toLocaleDateString('th-TH', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const el = document.getElementById('datetime'); if (el) el.innerText = `${dateStr} ${timeStr}`;
}
setInterval(updateDateTime, 1000); updateDateTime();

window.addEventListener('load', ()=>{
  setTimeout(()=>{ const s=document.getElementById('splash'); s.style.opacity='0'; setTimeout(()=>s.style.display='none',800); },1200);
  showOnly('welcome');
});

// Auth tabs
const loginTab = document.getElementById('loginTab');
const signupTab = document.getElementById('signupTab');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const authMessage = document.getElementById('authMessage');
loginTab.addEventListener('click', ()=>{ loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); authMessage.textContent=''; });
signupTab.addEventListener('click', ()=>{ signupForm.classList.remove('hidden'); loginForm.classList.add('hidden'); authMessage.textContent=''; });
loginTab.click();

// Email/Pass
loginForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  auth.signInWithEmailAndPassword(email, password).then(()=>showOnly('calculator')).catch(err=>authMessage.textContent=err.message);
});

// Signup
signupForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const firstName = document.getElementById('signupFirstName').value.trim();
  const lastName = document.getElementById('signupLastName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  if (!firstName || !lastName || !email || !password) { authMessage.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return; }
  auth.createUserWithEmailAndPassword(email, password)
    .then(cred=>{
      const user=cred.user;
      return user.updateProfile({ displayName: `${firstName} ${lastName}` })
        .then(()=> db.collection('users').doc(user.uid).set({
          uid:user.uid, firstName, lastName, email, phone:'', address:'', createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true}));
    })
    .then(()=>{ showOnly('profile'); loadProfile(); })
    .catch(err=> authMessage.textContent=err.message );
});

// Google Sign-in (Firebase Auth)
document.getElementById('googleSignInBtn').addEventListener('click', ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(async res=>{
      const user = res.user;
      const docRef = db.collection('users').doc(user.uid);
      const snap = await docRef.get();
      if (!snap.exists) {
        const [firstName, ...rest] = (user.displayName||'').split(' ');
        await docRef.set({
          uid:user.uid,
          firstName:firstName||'',
          lastName:(rest||[]).join(' ')||'',
          email:user.email||'',
          phone:'', address:'',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }
      showOnly('calculator');
    })
    .catch(err=> authMessage.textContent=err.message );
});

logoutBtn.addEventListener('click', ()=> auth.signOut());

auth.onAuthStateChanged((user)=>{
  if (user) {
    userGreeting.classList.remove('hidden');
    userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${user.displayName || user.email}`;
    loginNav.classList.add('hidden');
    logoutBtn.classList.remove('hidden');
  } else {
    userGreeting.classList.add('hidden');
    loginNav.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    showOnly('welcome');
  }
});

/* =========================
   Profile
   ========================= */
const profileForm = document.getElementById('profileForm');
const profileFirstName = document.getElementById('profileFirstName');
const profileLastName = document.getElementById('profileLastName');
const profileEmail = document.getElementById('profileEmail');
const profilePhone = document.getElementById('profilePhone');
const profileAddress = document.getElementById('profileAddress');
document.getElementById('reloadProfile').addEventListener('click', loadProfile);

async function loadProfile(){
  profileMsg.textContent='';
  const user = auth.currentUser;
  if (!user) { profileMsg.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; profileMsg.className='text-red-600 text-sm mt-2'; return; }
  try {
    const snap = await db.collection('users').doc(user.uid).get();
    if (snap.exists) {
      const d = snap.data();
      profileFirstName.value = d.firstName || '';
      profileLastName.value  = d.lastName  || '';
      profileEmail.value     = d.email     || user.email || '';
      profilePhone.value     = d.phone     || '';
      profileAddress.value   = d.address   || '';
      profileMsg.textContent='‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; profileMsg.className='text-green-600 text-sm mt-2';
    } else {
      profileFirstName.value = user.displayName ? user.displayName.split(' ')[0] : '';
      profileLastName.value  = user.displayName ? user.displayName.split(' ').slice(1).join(' ') : '';
      profileEmail.value     = user.email || '';
      profileMsg.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'; profileMsg.className='text-yellow-600 text-sm mt-2';
    }
  } catch(e){ profileMsg.textContent=e.message; profileMsg.className='text-red-600 text-sm mt-2'; }
}

profileForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); showOnly('auth'); return; }
  try {
    await db.collection('users').doc(user.uid).set({
      uid:user.uid,
      firstName: profileFirstName.value.trim(),
      lastName:  profileLastName.value.trim(),
      email:     profileEmail.value.trim() || user.email,
      phone:     profilePhone.value.trim(),
      address:   profileAddress.value.trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    await user.updateProfile({ displayName: `${profileFirstName.value.trim()} ${profileLastName.value.trim()}`.trim() });
    userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${user.displayName || user.email}`;
    profileMsg.textContent='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; profileMsg.className='text-green-600 text-sm mt-2';
  } catch(e){ profileMsg.textContent=e.message; profileMsg.className='text-red-600 text-sm mt-2'; }
});

/* =========================
   File input preview (client)
   ========================= */
const ALLOW_TYPES = ['image/jpeg','image/png','application/pdf'];
const MAX_FILES = 10;
const MAX_FILE_SIZE_MB = 8;

document.getElementById('receiptUpload').addEventListener('change', function(){
  const files = Array.from(this.files || []);
  if (files.length > MAX_FILES) { alert(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${MAX_FILES} ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á`); this.value=''; return; }
  for (const f of files) {
    if (!ALLOW_TYPES.includes(f.type)) { alert(`‡πÑ‡∏ü‡∏•‡πå ${f.name} ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (JPG/PNG/PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)`); this.value=''; return; }
    if (f.size > MAX_FILE_SIZE_MB*1024*1024) { alert(`‡πÑ‡∏ü‡∏•‡πå ${f.name} > ${MAX_FILE_SIZE_MB}MB`); this.value=''; return; }
  }
  const info = document.getElementById('fileInfo');
  const preview = document.getElementById('previewArea');
  if (info) info.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${files.length} ‡πÑ‡∏ü‡∏•‡πå`;
  if (preview) {
    preview.innerHTML = '';
    files.forEach(f=>{
      if (f.type.startsWith('image/')) {
        const fr = new FileReader();
        fr.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result; img.className='w-full h-24 object-cover rounded shadow';
          preview.appendChild(img);
        };
        fr.readAsDataURL(f);
      } else {
        const p = document.createElement('p'); p.textContent = `üìÑ ${f.name}`; p.className='text-xs text-gray-700';
        preview.appendChild(p);
      }
    });
  }
});

/* =========================
   Tax Calculator + Save + Upload (Drive)
   ========================= */
function calculateTax(income, expense, deduction){
  const net = income - expense - deduction;
  return net <= 150000 ? 0 : net * 0.05; // ‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
}

document.getElementById('taxForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const income = Number(document.getElementById('income').value);
  const expense = Number(document.getElementById('expense').value);
  const deduction = Number(document.getElementById('deduction').value);
  const fileInput = document.getElementById('receiptUpload');
  const files = fileInput?.files || [];

  if (Number.isNaN(income) || Number.isNaN(expense) || Number.isNaN(deduction)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  const tax = Number(calculateTax(income, expense, deduction)) || 0;

  // Pie
  const ctx = document.getElementById('taxPieChart').getContext('2d');
  if (window.taxChart instanceof Chart) window.taxChart.destroy();
  const needTax = (income - expense - deduction) > 150000 ? 100 : 0;
  window.taxChart = new Chart(ctx, {
    type:'pie',
    data:{ labels:['‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ','‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ'], datasets:[{ data:[needTax, 100-needTax], backgroundColor:['#ef4444','#22c55e'] }]},
    options:{ responsive:true, plugins:{ legend:{position:'top'}, title:{display:true, text:`‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${tax.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó` } } }
  });

  calcMsg.textContent = '';

  const user = auth.currentUser;
  if (!user) { calcMsg.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'; calcMsg.className='text-yellow-600 text-sm mt-3'; return; }

  try {
    // Firestore
    const docRef = await db.collection('users').doc(user.uid).collection('calculations').add({
      income: income||0, expense: expense||0, deduction: deduction||0, tax: tax||0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      receipts: []
    });

    // Drive
    let uploaded = [];
    if (files.length > 0) {
      await ensureDriveToken();
      const folderInfo = await getOrCreateDriveFolder();
      uploaded = await uploadFilesToDrive(files, folderInfo);
    }

    // update receipts
    if (uploaded.length) await docRef.update({ receipts: uploaded });

    if (fileInput) fileInput.value='';
    calcMsg.textContent = uploaded.length ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive ‡πÅ‡∏•‡πâ‡∏ß (${uploaded.length} ‡πÑ‡∏ü‡∏•‡πå)` : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß';
    calcMsg.className = 'text-green-600 text-sm mt-3';
  } catch(e){
    console.error(e);
    calcMsg.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message||''}`;
    calcMsg.className = 'text-red-600 text-sm mt-3';
  }
});

/* =========================
   History (load & delete)
   ========================= */
async function loadHistory(){
  historyMsg.textContent=''; historyBody.innerHTML='';
  const user = auth.currentUser;
  if (!user) { historyMsg.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; historyMsg.className='text-red-600'; return; }

  try {
    const snap = await db.collection('users').doc(user.uid)
      .collection('calculations').orderBy('createdAt','desc').limit(100).get();

    if (snap.empty) {
      historyBody.innerHTML = `<tr><td colspan="6" class="px-3 py-3 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</td></tr>`;
      return;
    }

    snap.forEach(doc=>{
      const d = doc.data();
      const dt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : new Date();

      const nFiles = Array.isArray(d.receipts) ? d.receipts.length : 0;
      const filesLinks = nFiles
        ? d.receipts.map((r,i)=>`<a href="${r.webViewLink}" target="_blank" class="text-blue-600 hover:underline">‡πÑ‡∏ü‡∏•‡πå ${i+1}</a>`).join(' ¬∑ ')
        : '<span class="text-gray-400">‚Äî</span>';

      const tr = document.createElement('tr');
      tr.className='border-b';
      tr.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${dt.toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap">${(d.income||0).toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap">${(d.expense||0).toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap">${(d.deduction||0).toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap font-semibold">${(d.tax||0).toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 space-y-1">
          <button data-del="${doc.id}" class="text-red-600 hover:underline text-xs">‡∏•‡∏ö</button>
          <div class="text-xs">${filesLinks}</div>
        </td>
      `;
      historyBody.appendChild(tr);
    });

    historyBody.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
        try {
          const user = auth.currentUser;
          const calcId = btn.getAttribute('data-del');
          await db.collection('users').doc(user.uid).collection('calculations').doc(calcId).delete();
          loadHistory();
        } catch(e){ alert(e.message); }
      });
    });

  } catch(e){
    historyMsg.textContent = e.message; historyMsg.className='text-red-600';
  }
}
document.getElementById('refreshHistory').addEventListener('click', loadHistory);

/* =========================
   Export CSV / PDF / Open Drive folder
   ========================= */
async function fetchAllCalculations() {
  const user = auth.currentUser;
  if (!user) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
  const snap = await db.collection('users').doc(user.uid)
    .collection('calculations').orderBy('createdAt','desc').get();
  return snap.docs.map(d => {
    const v = d.data();
    const dt = v.createdAt && v.createdAt.toDate ? v.createdAt.toDate() : null;
    return {
      id: d.id,
      date: dt ? dt.toLocaleString('th-TH') : '',
      income: v.income || 0,
      expense: v.expense || 0,
      deduction: v.deduction || 0,
      tax: v.tax || 0,
      receipts: Array.isArray(v.receipts) ? v.receipts : []
    };
  });
}

async function exportHistoryCSV() {
  try {
    const rows = await fetchAllCalculations();
    const header = ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ','‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢','‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô','‡∏†‡∏≤‡∏©‡∏µ','‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à(‡∏•‡∏¥‡∏á‡∏Å‡πå)'];
    const lines = [header.join(',')];
    rows.forEach(r => {
      const links = r.receipts.map((x,i) => x.webViewLink||'').join(' | ');
      lines.push([
        `"${r.date}"`,
        r.income,
        r.expense,
        r.deduction,
        r.tax,
        `"${links}"`
      ].join(','));
    });
    const csv = '\ufeff' + lines.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'taxonline_history.csv'; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { alert(e.message || e); }
}

async function exportHistoryPDF() {
  try {
    const rows = await fetchAllCalculations();
    if (!rows || rows.length === 0) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'); return; }

    const { jsPDF } = window.jspdf || {};
    if (!jsPDF || !('autoTable' in (new jsPDF()))) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö jsPDF ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏≠‡∏¥‡∏ô autoTable'); return;
    }

    const user = auth.currentUser;
    const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });

    doc.setFontSize(16);
    doc.text('‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ (TaxOnline)', 10, 14);
    doc.setFontSize(10);
    doc.text(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user ? (user.displayName || user.email) : '-'}`, 10, 20);
    doc.text(`‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}`, 10, 26);

    const head = [['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ','‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢','‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô','‡∏†‡∏≤‡∏©‡∏µ','‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à']];
    const body = rows.map((r) => [
      r.date || '',
      (r.income ?? 0).toLocaleString('th-TH'),
      (r.expense ?? 0).toLocaleString('th-TH'),
      (r.deduction ?? 0).toLocaleString('th-TH'),
      (r.tax ?? 0).toLocaleString('th-TH'),
      (r.receipts && r.receipts.length) ? r.receipts.map((x,i)=>`‡πÑ‡∏ü‡∏•‡πå ${i+1}`).join(' , ') : '‚Äî'
    ]);

    doc.autoTable({
      head, body,
      startY: 32,
      styles: { fontSize: 9, cellPadding: 2 },
      headStyles: { fillColor: [243,244,246], textColor: 0 },
      columnStyles: { 0:{cellWidth:32}, 1:{cellWidth:26}, 2:{cellWidth:26}, 3:{cellWidth:26}, 4:{cellWidth:26}, 5:{cellWidth:'auto'} },
      didDrawPage: () => {
        const pageCount = doc.internal.getNumberOfPages();
        const str = `‡∏´‡∏ô‡πâ‡∏≤ ${doc.internal.getCurrentPageInfo().pageNumber} / ${pageCount}`;
        doc.setFontSize(9);
        doc.text(str, 200 - doc.getTextWidth(str) - 10, 291);
      }
    });

    // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ)
    let y = doc.lastAutoTable.finalY + 6;
    const linkLines = [];
    rows.forEach((r, idx) => {
      (r.receipts || []).forEach((x, i) => {
        if (x.webViewLink) {
          linkLines.push({ text: `‡πÅ‡∏ñ‡∏ß ${idx + 1} ‚Üí ‡πÑ‡∏ü‡∏•‡πå ${i + 1}: ${x.webViewLink}`, url: x.webViewLink });
        }
      });
    });

    if (linkLines.length) {
      doc.setFontSize(11);
      doc.text('‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ):', 10, y);
      y += 5;
      doc.setFontSize(9);

      for (const ln of linkLines) {
        const wrapped = doc.splitTextToSize(ln.text, 190);
        doc.text(wrapped, 10, y);
        doc.link(10, y - 3, doc.getTextWidth(wrapped[0]), 5, { url: ln.url });
        y += wrapped.length * 5;
        if (y > 280) { doc.addPage(); y = 14; }
      }
    } else {
      const y0 = doc.lastAutoTable.finalY + 6;
      doc.setFontSize(10);
      doc.text('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ô‡∏ö‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ', 10, y0);
    }

    doc.save('taxonline_summary.pdf');
  } catch (e) {
    console.error(e);
    alert(e.message || e);
  }
}

async function openDriveFolder() {
  try {
    const { webViewLink } = await getOrCreateDriveFolder();
    if (!webViewLink) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå'); return; }
    window.open(webViewLink, '_blank');
  } catch(e) { alert(e.message || e); }
}

document.getElementById('downloadCsvBtn')?.addEventListener('click', exportHistoryCSV);
document.getElementById('downloadPdfBtn')?.addEventListener('click', exportHistoryPDF);
document.getElementById('openDriveFolderBtn')?.addEventListener('click', openDriveFolder);
</script>

<!-- ====================== Advanced Theme Customizer (Admin Only) ====================== -->
<script>
(function(){
  // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô UID ‡∏ô‡∏µ‡πâ
  const ADMIN_UIDS = ['oSPrvjRwNaVV4KQgbzOi3Re4Agm1'];
  const SETTINGS_DOC = { col: 'site_settings', id: 'default' };

  const $q = s => document.querySelector(s);
  function createEl(tag, attrs={}, children=[]) {
    const el = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k==='class') el.className = v;
      else if (k==='style') el.style.cssText = v;
      else el.setAttribute(k,v);
    });
    (Array.isArray(children)?children:[children]).forEach(c=>{
      if (c==null) return;
      if (typeof c==='string') el.appendChild(document.createTextNode(c));
      else el.appendChild(c);
    });
    return el;
  }

  // ---------- STATE ----------
  const state = {
    loaded:false,
    values:{
      brandTitle:'',
      welcomeTitle:'',
      welcomeSubtext:'',
      primaryColor:'#2563eb',
      accentColor:'#f59e0b',
      buttonRadius:12,
      darkDefault:false,
      fontUrl:'',
      fontCssFamily:'system-ui',
      hideWelcome:false,
      hideProfile:false,
      hideCalculator:false,
      hideHistory:false,
      logo:null // {driveFileId, webViewLink, embedUrl, name, mimeType}
    }
  };

  // ---------- Drive helpers ----------
  async function getOrCreateDriveAssetsFolder() {
    if (typeof ensureDriveToken !== 'function') throw new Error('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î ‚Äú‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive‚Äù ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
    await ensureDriveToken();
    const q = "name='TaxOnline Assets' and mimeType='application/vnd.google-apps.folder' and trashed=false";
    const search = await fetch(
      'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(q) + '&fields=files(id,webViewLink)',
      { headers: { 'Authorization': 'Bearer ' + (window.driveAccessToken || '') } }
    );
    if (search.ok) {
      const j = await search.json();
      if (j.files && j.files.length) return { id: j.files[0].id, webViewLink: j.files[0].webViewLink };
    }
    const res = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,webViewLink', {
      method:'POST',
      headers:{ 'Authorization':'Bearer '+(window.driveAccessToken||''), 'Content-Type':'application/json' },
      body: JSON.stringify({ name:'TaxOnline Assets', mimeType:'application/vnd.google-apps.folder' })
    });
    if (!res.ok) throw new Error('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Assets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const d = await res.json();
    return { id: d.id, webViewLink: d.webViewLink };
  }

  // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (anyone with the link) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô
  async function makeFilePublic(fileId){
    await ensureDriveToken();
    const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}/permissions`;
    const res = await fetch(url, {
      method:'POST',
      headers:{
        'Authorization':'Bearer '+(window.driveAccessToken||''),
        'Content-Type':'application/json'
      },
      body: JSON.stringify({ role:'reader', type:'anyone' })
    });
    // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á ok ‡πÄ‡∏™‡∏°‡∏≠ ‚Äî ‡∏ñ‡πâ‡∏≤ scope/‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏´‡πâ‡∏≤‡∏° ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå
    return res.ok;
  }

  async function uploadLogoToDrive(file) {
    if (!file) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ');
    if (typeof ensureDriveToken !== 'function') throw new Error('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î ‚Äú‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive‚Äù ‡∏Å‡πà‡∏≠‡∏ô');
    await ensureDriveToken();
    const parent = await getOrCreateDriveAssetsFolder();
    const meta = { name:file.name, mimeType:file.type||'application/octet-stream', parents:[parent.id] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(meta)], { type:'application/json' }));
    form.append('file', file);
    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
      method:'POST', headers:{ 'Authorization':'Bearer '+(window.driveAccessToken||'') }, body: form
    });
    if (!res.ok) throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    const j = await res.json();

    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á anyoneWithLink ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
    await makeFilePublic(j.id).catch(()=>{});

    // embed URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <img>
    const embedUrl = `https://drive.google.com/uc?export=view&id=${j.id}`;
    return { driveFileId: j.id, webViewLink: j.webViewLink, embedUrl, name: file.name, mimeType: file.type||null };
  }

  // ---------- Apply theme ----------
  function ensureLogoSlot() {
    let slot = document.getElementById('logoSlot');
    if (slot) return slot;
    const hdr = document.querySelector('header .max-w-6xl .flex.items-center');
    if (!hdr) return null;
    slot = createEl('div', { id:'logoSlot', class:'flex items-center gap-2' });
    const img = createEl('img', { id:'siteLogo', alt:'Logo', class:'h-8 w-8 rounded-lg hidden' });
    slot.appendChild(img);
    const h1 = hdr.querySelector('h1');
    if (h1) { hdr.insertBefore(slot, h1); slot.appendChild(h1); } else { hdr.prepend(slot); }
    return slot;
  }

  function injectFont(url) {
    if (!url) return;
    let link = document.getElementById('customFontLink');
    if (!link) { link = document.createElement('link'); link.id='customFontLink'; link.rel='stylesheet'; document.head.appendChild(link); }
    link.href = url;
  }

  function applySettings(v) {
    if (v.fontUrl) injectFont(v.fontUrl);
    document.documentElement.style.setProperty('--tx-font', v.fontCssFamily || 'system-ui');
    document.body.style.fontFamily = 'var(--tx-font)';

    document.documentElement.style.setProperty('--tx-primary', v.primaryColor || '#2563eb');
    document.documentElement.style.setProperty('--tx-accent',  v.accentColor  || '#f59e0b');

    ['#welcomeSection [data-nav="calculator"]', '#welcomeLoginBtn', '#taxForm button[type="submit"]', '#driveConnectBtn']
      .forEach(sel=>{
        const el = $q(sel); if (!el) return;
        el.style.backgroundColor = 'var(--tx-primary)';
        el.style.borderColor     = 'var(--tx-primary)';
        el.style.color           = '#fff';
        el.style.borderRadius    = (v.buttonRadius||12)+'px';
      });

    ['#downloadCsvBtn','#downloadPdfBtn','#openDriveFolderBtn'].forEach(sel=>{
      const el = $q(sel); if (!el) return;
      el.style.backgroundColor = 'var(--tx-accent)'; el.style.color = '#1f2937';
      el.style.borderRadius = (v.buttonRadius||12)+'px';
    });

    if (v.darkDefault) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');

    if (v.brandTitle)   { const h=$q('header h1'); if (h) h.textContent = v.brandTitle; }
    if (v.welcomeTitle) { const h=$q('#welcomeSection h2'); if (h) h.textContent = v.welcomeTitle; }
    if (v.welcomeSubtext){ const p=$q('#welcomeSection p'); if (p) p.textContent = v.welcomeSubtext; }

    const slot = ensureLogoSlot();
    const img = slot ? slot.querySelector('#siteLogo') : null;
    if (img) {
      if (v.logo && (v.logo.embedUrl || v.logo.webViewLink)) {
        img.src = v.logo.embedUrl || v.logo.webViewLink;
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden'); img.removeAttribute('src');
      }
    }

    [
      {key:'hideWelcome',    sel:'#welcomeSection'},
      {key:'hideProfile',    sel:'#profileSection'},
      {key:'hideCalculator', sel:'#calculatorSection'},
      {key:'hideHistory',    sel:'#historySection'}
    ].forEach(m=>{
      const el = $q(m.sel); if (!el) return;
      el.style.display = v[m.key] ? 'none' : '';
    });
  }

  // ---------- Firestore I/O ----------
  async function loadSettings() {
    try {
      const ref = firebase.firestore().collection(SETTINGS_DOC.col).doc(SETTINGS_DOC.id);
      const snap = await ref.get();
      if (snap.exists) {
        state.values = Object.assign(state.values, snap.data() || {});
      } else {
        state.values.brandTitle   = ($q('header h1')?.textContent || 'TaxOnline').trim();
        state.values.welcomeTitle = ($q('#welcomeSection h2')?.textContent || '').trim();
        state.values.welcomeSubtext = ($q('#welcomeSection p')?.textContent || '').trim();
      }
      applySettings(state.values);
      state.loaded = true;
    } catch (e) { console.error('load settings failed:', e); }
  }

  async function saveSettings(values) {
    const user = firebase.auth().currentUser;
    if (!user) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    if (ADMIN_UIDS && !ADMIN_UIDS.includes(user.uid)) throw new Error('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á');

    const payload = Object.assign({}, values, {
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: user.uid
    });
    await firebase.firestore().collection(SETTINGS_DOC.col).doc(SETTINGS_DOC.id).set(payload, { merge:true });
    state.values = Object.assign(state.values, values);
    applySettings(state.values);
  }

  // ---------- UI (Admin only) ----------
  function removeAdminUI(){
    document.getElementById('advCustomizeFab')?.remove();
    document.getElementById('advCustomizeOverlay')?.remove();
  }

  function mountAdminUI(){
    if (document.getElementById('advCustomizeFab')) return; // already mounted

    const fab = createEl('button', {
      id:'advCustomizeFab', type:'button',
      class:'fixed z-[10000] right-4 bottom-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full shadow-lg'
    }, 'üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°');
    document.body.appendChild(fab);

    const overlay = createEl('div', {
      id:'advCustomizeOverlay',
      class:'fixed inset-0 hidden',
      style:'background:rgba(0,0,0,.45);z-index:9999;'
    });
    const panel = createEl('div', {
      class:'absolute right-0 top-0 h-full w-full sm:w-[480px] bg-white shadow-2xl p-5 overflow-auto',
      style:'z-index:10000;'
    });
    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    // ‡∏õ‡∏¥‡∏î overlay ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    overlay.addEventListener('click', (e)=>{
      if (e.target === overlay) { overlay.classList.add('hidden'); document.body.style.overflow=''; }
    });
    // ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ ESC
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && !overlay.classList.contains('hidden')) {
        overlay.classList.add('hidden'); document.body.style.overflow='';
      }
    });

    panel.innerHTML = `
      <h3 class="text-xl font-semibold mb-1 text-indigo-600">‡∏õ‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</h3>
      <p class="text-xs text-gray-500 mb-4">‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏™‡∏µ ‡∏ü‡∏≠‡∏ô‡∏ï‡πå ‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>

      <form id="adv_form" class="space-y-4" novalidate>
        <fieldset class="border rounded p-3">
          <legend class="px-2 text-sm font-semibold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</legend>
          <label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö/‡πÇ‡∏•‡πÇ‡∏Å‡πâ (Header)</label>
          <input type="text" id="adv_brandTitle" class="w-full p-2 border rounded mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô TaxOnline">
          <label class="block text-sm mb-1">‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
          <input type="text" id="adv_welcomeTitle" class="w-full p-2 border rounded mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏á‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ!">
          <label class="block text-sm mb-1">‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
          <textarea id="adv_welcomeSubtext" rows="3" class="w-full p-2 border rounded" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå"></textarea>
        </fieldset>

        <fieldset class="border rounded p-3">
          <legend class="px-2 text-sm font-semibold">‡∏ò‡∏µ‡∏°‡∏™‡∏µ & ‡∏õ‡∏∏‡πà‡∏°</legend>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å (Primary)</label>
              <input type="color" id="adv_primaryColor" class="w-full h-10 p-0 border rounded" value="#2563eb">
            </div>
            <div>
              <label class="block text-sm mb-1">‡∏™‡∏µ‡∏£‡∏≠‡∏á (Accent)</label>
              <input type="color" id="adv_accentColor" class="w-full h-10 p-0 border rounded" value="#f59e0b">
            </div>
          </div>
          <label class="block text-sm mt-3">‡∏°‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏° (px)</label>
          <input type="range" id="adv_buttonRadius" min="0" max="24" step="1" value="12" class="w-full">
          <div class="text-xs text-gray-500 mt-1">‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="radiusVal">12</span>px</div>
          <label class="inline-flex items-center gap-2 mt-3 cursor-pointer">
            <input type="checkbox" id="adv_darkDefault" class="form-checkbox"> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î (Dark by default)
          </label>
        </fieldset>

        <fieldset class="border rounded p-3">
          <legend class="px-2 text-sm font-semibold">‡∏ü‡∏≠‡∏ô‡∏ï‡πå</legend>
          <label class="block text-sm mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡πá‡∏ß</label>
          <select id="adv_fontQuick" class="w-full p-2 border rounded mb-2">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option value='{"url":"https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap","family":"Sarabun, sans-serif"}'>Sarabun (‡πÑ‡∏ó‡∏¢)</option>
            <option value='{"url":"https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap","family":"Prompt, sans-serif"}'>Prompt (‡πÑ‡∏ó‡∏¢)</option>
            <option value='{"url":"https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600&display=swap","family":"Noto Sans Thai, sans-serif"}'>Noto Sans Thai</option>
            <option value='{"url":"https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap","family":"Inter, system-ui, sans-serif"}'>Inter</option>
          </select>
          <div class="grid grid-cols-1 gap-2">
            <div>
              <label class="block text-sm mb-1">Google Fonts / CSS URL</label>
              <input type="url" id="adv_fontUrl" class="w-full p-2 border rounded" placeholder="https://fonts.googleapis.com/...">
            </div>
            <div>
              <label class="block text-sm mb-1">font-family (CSS)</label>
              <input type="text" id="adv_fontCssFamily" class="w-full p-2 border rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô 'Sarabun, sans-serif'">
            </div>
          </div>
          <div class="text-xs text-gray-500 mt-2">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL/‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏≠‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ</div>
          <button type="button" id="adv_tryFont" class="mt-2 px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
        </fieldset>

        <fieldset class="border rounded p-3">
          <legend class="px-2 text-sm font-semibold">‡πÇ‡∏•‡πÇ‡∏Å‡πâ</legend>
          <div class="flex items-center gap-3">
            <input type="file" id="adv_logoFile" accept="image/*" class="text-sm">
            <button type="button" id="adv_uploadLogo" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Drive</button>
          </div>
          <div id="adv_logoPreview" class="mt-2 text-sm text-gray-500"></div>
          <div class="text-xs text-gray-500 mt-1">* ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå "TaxOnline Assets" ‡∏ö‡∏ô Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        </fieldset>

        <fieldset class="border rounded p-3">
          <legend class="px-2 text-sm font-semibold">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ</legend>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideWelcome"> ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideProfile"> ‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideCalculator"> ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideHistory"> ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</label>
          </div>
        </fieldset>

        <div class="flex items-center justify-between pt-2">
          <button type="button" id="adv_preview" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded">‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
          <div class="space-x-2">
            <button type="button" id="adv_close" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded">‡∏õ‡∏¥‡∏î</button>
            <!-- ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô button (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà submit) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏Å‡∏±‡∏ö form -->
            <button type="button" id="adv_save" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </div>
        <p id="adv_msg" class="text-xs text-gray-500 mt-1"></p>
      </form>
    `;

    // ‡∏Å‡∏±‡∏ô submit ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
    panel.querySelector('#adv_form').addEventListener('submit', e => { e.preventDefault(); e.stopPropagation(); });

    function fillForm(v){
      panel.querySelector('#adv_brandTitle').value     = v.brandTitle   || ($q('header h1')?.textContent || 'TaxOnline');
      panel.querySelector('#adv_welcomeTitle').value   = v.welcomeTitle || ($q('#welcomeSection h2')?.textContent || '');
      panel.querySelector('#adv_welcomeSubtext').value = v.welcomeSubtext || ($q('#welcomeSection p')?.textContent || '');
      panel.querySelector('#adv_primaryColor').value   = v.primaryColor || '#2563eb';
      panel.querySelector('#adv_accentColor').value    = v.accentColor  || '#f59e0b';
      panel.querySelector('#adv_buttonRadius').value   = v.buttonRadius ?? 12;
      panel.querySelector('#radiusVal').textContent    = v.buttonRadius ?? 12;
      panel.querySelector('#adv_darkDefault').checked  = !!v.darkDefault;
      panel.querySelector('#adv_fontUrl').value        = v.fontUrl || '';
      panel.querySelector('#adv_fontCssFamily').value  = v.fontCssFamily || 'system-ui';
      panel.querySelector('#adv_hideWelcome').checked    = !!v.hideWelcome;
      panel.querySelector('#adv_hideProfile').checked    = !!v.hideProfile;
      panel.querySelector('#adv_hideCalculator').checked = !!v.hideCalculator;
      panel.querySelector('#adv_hideHistory').checked    = !!v.hideHistory;

      const prev = panel.querySelector('#adv_logoPreview');
      if (v.logo && v.logo.webViewLink) {
        prev.innerHTML = `<a href="${v.logo.webViewLink}" target="_blank" rel="noopener" class="text-blue-600 underline">‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${v.logo.name||'‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå'}</a>`;
      } else prev.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏•‡πÇ‡∏Å‡πâ';
    }

    function collectValues(){
      return {
        brandTitle: panel.querySelector('#adv_brandTitle').value.trim(),
        welcomeTitle: panel.querySelector('#adv_welcomeTitle').value.trim(),
        welcomeSubtext: panel.querySelector('#adv_welcomeSubtext').value.trim(),
        primaryColor: panel.querySelector('#adv_primaryColor').value,
        accentColor:  panel.querySelector('#adv_accentColor').value,
        buttonRadius: parseInt(panel.querySelector('#adv_buttonRadius').value||'12',10),
        darkDefault:  panel.querySelector('#adv_darkDefault').checked,
        fontUrl:      panel.querySelector('#adv_fontUrl').value.trim(),
        fontCssFamily:panel.querySelector('#adv_fontCssFamily').value.trim()||'system-ui',
        hideWelcome:    panel.querySelector('#adv_hideWelcome').checked,
        hideProfile:    panel.querySelector('#adv_hideProfile').checked,
        hideCalculator: panel.querySelector('#adv_hideCalculator').checked,
        hideHistory:    panel.querySelector('#adv_hideHistory').checked,
        logo: state.values.logo || null
      };
    }

    // events
    panel.querySelector('#adv_buttonRadius').addEventListener('input', e=>{
      panel.querySelector('#radiusVal').textContent = e.target.value;
    });

    panel.querySelector('#adv_tryFont').addEventListener('click', ()=>{
      const url = panel.querySelector('#adv_fontUrl').value.trim();
      const fam = panel.querySelector('#adv_fontCssFamily').value.trim() || 'system-ui';
      applySettings(Object.assign({}, state.values, { fontUrl:url, fontCssFamily:fam }));
      panel.querySelector('#adv_msg').textContent = '‡∏•‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
    });

    panel.querySelector('#adv_uploadLogo').addEventListener('click', async ()=>{
      const f = panel.querySelector('#adv_logoFile').files[0];
      if (!f) { alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const msg = panel.querySelector('#adv_msg');
      try {
        msg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ...';
        const res = await uploadLogoToDrive(f);
        state.values.logo = res;
        applySettings(state.values);
        panel.querySelector('#adv_logoPreview').innerHTML =
          `<a href="${res.webViewLink}" target="_blank" rel="noopener" class="text-blue-600 underline">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${res.name}</a>`;
        msg.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")';
      } catch(e){ msg.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (e.message||e); }
    });

    panel.querySelector('#adv_preview').addEventListener('click', ()=>{
      applySettings(Object.assign({}, state.values, collectValues()));
      panel.querySelector('#adv_msg').textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
    });

    panel.querySelector('#adv_close').addEventListener('click', ()=>{
      overlay.classList.add('hidden'); document.body.style.overflow='';
    });

    panel.querySelector('#adv_save').addEventListener('click', async ()=>{
      const msg = panel.querySelector('#adv_msg');
      try {
        msg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        await saveSettings(collectValues());
        msg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî';
        overlay.classList.add('hidden'); document.body.style.overflow='';
      } catch(err){ msg.textContent = (err.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); }
    });

    fab.addEventListener('click', ()=>{
      const user = firebase.auth().currentUser;
      if (!user) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
      if (ADMIN_UIDS && !ADMIN_UIDS.includes(user.uid)) { alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á'); return; }
      fillForm(state.values);
      overlay.classList.remove('hidden'); document.body.style.overflow='hidden';
    });
  }

  // ---------- BOOT ----------
  const boot = ()=>{ loadSettings(); };
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();

  // ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô + ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô UI ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
  firebase.auth().onAuthStateChanged((user)=>{
    if (state.loaded) loadSettings();
    if (user && ADMIN_UIDS.includes(user.uid)) {
      mountAdminUI();
    } else {
      removeAdminUI();
    }
  });
})();
</script>

</body>
</html>
