<script>
/* =========================
   TaxOnline: Advanced Theme Customizer (no-code)
   - Save to Firestore: site_settings/default
   - Optional admin lock (UIDs) ‚Äî set ADMIN_UIDS if you want to restrict
   - Uses Drive API to upload logo to user's Drive (folder: TaxOnline Assets)
   ========================= */
(function(){
  const ADMIN_UIDS = null; // e.g. ['YOUR_UID']; set to restrict; keep null to allow any signed-in user
  const SETTINGS_DOC = { col: 'site_settings', id: 'default' };

  // --------- Drive helpers (reuse your token; make a separate assets folder) ----------
  async function getOrCreateDriveAssetsFolder() {
    if (typeof ensureDriveToken !== 'function') throw new Error('ensureDriveToken() not found');
    await ensureDriveToken();
    const q = "name='TaxOnline Assets' and mimeType='application/vnd.google-apps.folder' and trashed=false";
    const search = await fetch(
      'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(q) + '&fields=files(id,webViewLink)',
      { headers: { 'Authorization': 'Bearer ' + (window.driveAccessToken || '') } }
    );
    if (search.ok) {
      const j = await search.json();
      if (j.files && j.files.length) return { id: j.files[0].id, webViewLink: j.files[0].webViewLink };
    }
    // create
    const res = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,webViewLink', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + (window.driveAccessToken || ''),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name:'TaxOnline Assets', mimeType:'application/vnd.google-apps.folder' })
    });
    if (!res.ok) throw new Error('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Assets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const d = await res.json();
    return { id: d.id, webViewLink: d.webViewLink };
  }

  async function uploadSingleToAssets(file) {
    if (!file) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå');
    if (typeof ensureDriveToken !== 'function') throw new Error('ensureDriveToken() not found');
    await ensureDriveToken();
    const parent = await getOrCreateDriveAssetsFolder();

    const meta = { name: file.name, mimeType: file.type || 'application/octet-stream', parents: [parent.id] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(meta)], { type:'application/json' }));
    form.append('file', file);
    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
      method:'POST',
      headers:{ 'Authorization': 'Bearer ' + (window.driveAccessToken || '') },
      body: form
    });
    if (!res.ok) throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    const j = await res.json();
    return { driveFileId: j.id, webViewLink: j.webViewLink, name: file.name, mimeType: file.type || null };
  }

  // --------- state ---------
  const state = {
    loaded: false,
    values: {
      brandTitle: '',
      welcomeTitle: '',
      welcomeSubtext: '',
      primaryColor: '#2563eb',
      accentColor: '#f59e0b',
      fontFamily: 'system-ui',
      fontUrl: '',                 // e.g. https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap
      fontCssFamily: '',           // e.g. 'Sarabun, sans-serif'
      darkDefault: false,
      buttonRadius: 12,            // px
      hideWelcome: false,
      hideProfile: false,
      hideCalculator: false,
      hideHistory: false,
      logo: null                   // { driveFileId, webViewLink, name, mimeType }
    }
  };

  // --------- DOM helpers ----------
  const $q = (s)=>document.querySelector(s);
  function createEl(tag, attrs={}, children=[]) {
    const el = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k==='class') el.className = v;
      else if (k==='style') el.style.cssText = v;
      else el.setAttribute(k,v);
    });
    (Array.isArray(children)?children:[children]).forEach(c=>{
      if (c==null) return;
      if (typeof c==='string') el.appendChild(document.createTextNode(c));
      else el.appendChild(c);
    });
    return el;
  }

  // --------- apply settings ----------
  function ensureHeaderLogoContainer() {
    let slot = document.getElementById('logoSlot');
    if (slot) return slot;
    const hdr = document.querySelector('header .max-w-6xl .flex.items-center');
    if (!hdr) return null;
    slot = createEl('div', { id:'logoSlot', class:'flex items-center gap-2' });
    // ‡πÅ‡∏ó‡∏£‡∏Å <img> ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô h1
    const img = createEl('img', { id:'siteLogo', alt:'Logo', class:'h-8 w-8 rounded-lg hidden' });
    slot.appendChild(img);
    // ‡∏¢‡πâ‡∏≤‡∏¢ h1 ‡πÄ‡∏Ç‡πâ‡∏≤ slot
    const h1 = hdr.querySelector('h1');
    if (h1) {
      hdr.insertBefore(slot, h1);
      slot.appendChild(h1);
    } else {
      hdr.prepend(slot);
    }
    return slot;
  }

  function injectFontLink(url) {
    if (!url) return;
    let link = document.getElementById('customFontLink');
    if (!link) {
      link = document.createElement('link');
      link.id = 'customFontLink';
      link.rel = 'stylesheet';
      document.head.appendChild(link);
    }
    link.href = url;
  }

  function applySettings(v) {
    // 1) Font
    if (v.fontUrl) injectFontLink(v.fontUrl);
    const family = v.fontCssFamily || v.fontFamily || 'system-ui';
    document.documentElement.style.setProperty('--tx-font', family);
    document.body.style.fontFamily = 'var(--tx-font)';

    // 2) Colors (CSS vars)
    document.documentElement.style.setProperty('--tx-primary', v.primaryColor || '#2563eb');
    document.documentElement.style.setProperty('--tx-accent', v.accentColor || '#f59e0b');

    // ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å ‡πÜ
    [
      '#welcomeSection [data-nav="calculator"]',
      '#welcomeLoginBtn',
      '#taxForm button[type="submit"]',
      '#driveConnectBtn'
    ].forEach(sel=>{
      const btn = $q(sel);
      if (btn) {
        btn.style.backgroundColor = 'var(--tx-primary)';
        btn.style.borderColor = 'var(--tx-primary)';
        btn.style.color = '#fff';
        btn.style.borderRadius = (v.buttonRadius||12) + 'px';
      }
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≠‡∏á
    ['#downloadPdfBtn','#downloadCsvBtn','#openDriveFolderBtn'].forEach(sel=>{
      const b = $q(sel);
      if (b) {
        b.style.backgroundColor = 'var(--tx-accent)';
        b.style.color = '#1f2937';
        b.style.borderRadius = (v.buttonRadius||12) + 'px';
      }
    });

    // 3) Dark default
    if (v.darkDefault) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');

    // 4) Texts
    if (v.brandTitle) { const h=$q('header h1'); if (h) h.textContent=v.brandTitle; }
    if (v.welcomeTitle){ const w=$q('#welcomeSection h2'); if (w) w.textContent=v.welcomeTitle; }
    if (v.welcomeSubtext){ const p=$q('#welcomeSection p'); if (p) p.textContent=v.welcomeSubtext; }

    // 5) Logo
    const slot = ensureHeaderLogoContainer();
    const img = slot ? slot.querySelector('#siteLogo') : null;
    if (img) {
      if (v.logo && v.logo.webViewLink) {
        img.src = v.logo.webViewLink; // Drive webViewLink (‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô icon ‡πÑ‡∏î‡πâ)
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden');
        img.removeAttribute('src');
      }
    }

    // 6) Visibility
    const map = [
      { key:'hideWelcome',   sel:'#welcomeSection' },
      { key:'hideProfile',   sel:'#profileSection' },
      { key:'hideCalculator',sel:'#calculatorSection' },
      { key:'hideHistory',   sel:'#historySection' }
    ];
    map.forEach(m=>{
      const el = $q(m.sel);
      if (el) { el.style.display = v[m.key] ? 'none' : ''; }
    });
  }

  // --------- Firestore I/O ----------
  async function loadSettings(){
    try {
      const ref = firebase.firestore().collection(SETTINGS_DOC.col).doc(SETTINGS_DOC.id);
      const snap = await ref.get();
      if (snap.exists) {
        state.values = Object.assign(state.values, snap.data() || {});
      } else {
        // defaults from current page
        state.values.brandTitle = ($q('header h1')?.textContent || 'TaxOnline').trim();
        state.values.welcomeTitle = ($q('#welcomeSection h2')?.textContent || '').trim();
        state.values.welcomeSubtext = ($q('#welcomeSection p')?.textContent || '').trim();
      }
      applySettings(state.values);
      state.loaded = true;
    } catch (e) { console.error('load settings failed:', e); }
  }

  async function saveSettings(values){
    const user = firebase.auth().currentUser;
    if (!user) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    if (ADMIN_UIDS && !ADMIN_UIDS.includes(user.uid)) throw new Error('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á');
    const payload = Object.assign({}, values, {
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: user.uid
    });
    await firebase.firestore().collection(SETTINGS_DOC.col).doc(SETTINGS_DOC.id).set(payload, { merge:true });
    state.values = Object.assign(state.values, values);
    applySettings(state.values);
  }

  // --------- UI (floating button + panel) ----------
  function mountUI(){
    // FAB
    const fab = createEl('button', { id:'advCustomizeFab',
      class:'fixed z-50 right-4 bottom-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full shadow-lg'
    }, 'üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°');
    document.body.appendChild(fab);

    // Overlay & Panel
    const overlay = createEl('div', { id:'advCustomizeOverlay', class:'fixed inset-0 z-50 hidden', style:'background:rgba(0,0,0,.45)' });
    const panel = createEl('div', { class:'absolute right-0 top-0 h-full w-full sm:w-[480px] bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 shadow-2xl p-5 overflow-auto' });
    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    panel.appendChild(createEl('h3', { class:'text-xl font-semibold mb-1 text-indigo-600 dark:text-indigo-300' }, '‡∏õ‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á'));
    panel.appendChild(createEl('p', { class:'text-xs text-gray-500 dark:text-gray-400 mb-4' }, '‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏™‡∏µ ‡∏ü‡∏≠‡∏ô‡∏ï‡πå ‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'));

    const form = createEl('form', { class:'space-y-4' });
    form.innerHTML = `
      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</legend>
        <label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö/‡πÇ‡∏•‡πÇ‡∏Å‡πâ (Header)</label>
        <input type="text" id="adv_brandTitle" class="w-full p-2 border rounded mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô TaxOnline">
        <label class="block text-sm mb-1">‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
        <input type="text" id="adv_welcomeTitle" class="w-full p-2 border rounded mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏á‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ!">
        <label class="block text-sm mb-1">‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
        <textarea id="adv_welcomeSubtext" rows="3" class="w-full p-2 border rounded" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå"></textarea>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏ò‡∏µ‡∏°‡∏™‡∏µ & ‡∏õ‡∏∏‡πà‡∏°</legend>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å (Primary)</label>
            <input type="color" id="adv_primaryColor" class="w-full h-10 p-0 border rounded" value="#2563eb">
          </div>
          <div>
            <label class="block text-sm mb-1">‡∏™‡∏µ‡∏£‡∏≠‡∏á (Accent)</label>
            <input type="color" id="adv_accentColor" class="w-full h-10 p-0 border rounded" value="#f59e0b">
          </div>
        </div>
        <label class="block text-sm mt-3">‡∏°‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏° (px)</label>
        <input type="range" id="adv_buttonRadius" min="0" max="24" step="1" value="12" class="w-full">
        <div class="text-xs text-gray-500 mt-1">‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="radiusVal">12</span>px</div>
        <label class="inline-flex items-center gap-2 mt-3 cursor-pointer">
          <input type="checkbox" id="adv_darkDefault" class="form-checkbox"> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î (Dark by default)
        </label>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏ü‡∏≠‡∏ô‡∏ï‡πå</legend>
        <label class="block text-sm mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡πá‡∏ß</label>
        <select id="adv_fontQuick" class="w-full p-2 border rounded mb-2">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap","family":"Sarabun, sans-serif"}'>Sarabun (‡πÑ‡∏ó‡∏¢)</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap","family":"Prompt, sans-serif"}'>Prompt (‡πÑ‡∏ó‡∏¢)</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600&display=swap","family":"Noto Sans Thai, sans-serif"}'>Noto Sans Thai</option>
          <option value='{"url":"https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap","family":"Inter, system-ui, sans-serif"}'>Inter</option>
        </select>
        <div class="grid grid-cols-1 gap-2">
          <div>
            <label class="block text-sm mb-1">Google Fonts / CSS URL</label>
            <input type="url" id="adv_fontUrl" class="w-full p-2 border rounded" placeholder="https://fonts.googleapis.com/...">
          </div>
          <div>
            <label class="block text-sm mb-1">font-family (CSS)</label>
            <input type="text" id="adv_fontCssFamily" class="w-full p-2 border rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô 'Sarabun, sans-serif'">
          </div>
        </div>
        <div class="text-xs text-gray-500 mt-2">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL/‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏≠‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ</div>
        <button type="button" id="adv_tryFont" class="mt-2 px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡πÇ‡∏•‡πÇ‡∏Å‡πâ</legend>
        <div class="flex items-center gap-3">
          <input type="file" id="adv_logoFile" accept="image/*" class="text-sm">
          <button type="button" id="adv_uploadLogo" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Drive</button>
        </div>
        <div id="adv_logoPreview" class="mt-2 text-sm text-gray-500"></div>
        <div class="text-xs text-gray-500 mt-1">* ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå "TaxOnline Assets" ‡∏ö‡∏ô Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
      </fieldset>

      <fieldset class="border rounded p-3">
        <legend class="px-2 text-sm font-semibold">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ</legend>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideWelcome"> ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideProfile"> ‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideCalculator"> ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adv_hideHistory"> ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</label>
        </div>
      </fieldset>

      <div class="flex items-center justify-between pt-2">
        <button type="button" id="adv_preview" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded">‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        <div class="space-x-2">
          <button type="button" id="adv_close" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded">‡∏õ‡∏¥‡∏î</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
      <p id="adv_msg" class="text-xs text-gray-500 mt-1"></p>
    `;
    panel.appendChild(form);

    // Prefill
    function fillForm(v){
      document.getElementById('adv_brandTitle').value = v.brandTitle || ($q('header h1')?.textContent || 'TaxOnline');
      document.getElementById('adv_welcomeTitle').value = v.welcomeTitle || ($q('#welcomeSection h2')?.textContent || '');
      document.getElementById('adv_welcomeSubtext').value = v.welcomeSubtext || ($q('#welcomeSection p')?.textContent || '');
      document.getElementById('adv_primaryColor').value = v.primaryColor || '#2563eb';
      document.getElementById('adv_accentColor').value  = v.accentColor  || '#f59e0b';
      document.getElementById('adv_buttonRadius').value = v.buttonRadius ?? 12;
      document.getElementById('radiusVal').textContent  = v.buttonRadius ?? 12;
      document.getElementById('adv_darkDefault').checked= !!v.darkDefault;
      document.getElementById('adv_fontUrl').value      = v.fontUrl || '';
      document.getElementById('adv_fontCssFamily').value= v.fontCssFamily || v.fontFamily || 'system-ui';
      document.getElementById('adv_hideWelcome').checked   = !!v.hideWelcome;
      document.getElementById('adv_hideProfile').checked   = !!v.hideProfile;
      document.getElementById('adv_hideCalculator').checked= !!v.hideCalculator;
      document.getElementById('adv_hideHistory').checked   = !!v.hideHistory;

      const logoPrev = document.getElementById('adv_logoPreview');
      if (v.logo && v.logo.webViewLink) {
        logoPrev.innerHTML = `<a href="${v.logo.webViewLink}" target="_blank" class="text-blue-600 underline">‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${v.logo.name || '‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå'}</a>`;
      } else {
        logoPrev.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏•‡πÇ‡∏Å‡πâ';
      }
    }

    // events
    fab.addEventListener('click', ()=>{
      const user = firebase.auth().currentUser;
      if (!user) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
      if (ADMIN_UIDS && !ADMIN_UIDS.includes(user.uid)) { alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á'); return; }
      fillForm(state.values);
      overlay.classList.remove('hidden');
    });
    document.getElementById('adv_close').addEventListener('click', ()=> overlay.classList.add('hidden'));
    overlay.addEventListener('click', (e)=>{ if (e.target===overlay) overlay.classList.add('hidden'); });

    document.getElementById('adv_buttonRadius').addEventListener('input', (e)=>{
      document.getElementById('radiusVal').textContent = e.target.value;
    });

    // quick font picker
    document.getElementById('adv_fontQuick').addEventListener('change', (e)=>{
      const val = e.target.value;
      if (!val) return;
      try {
        const o = JSON.parse(val);
        document.getElementById('adv_fontUrl').value = o.url || '';
        document.getElementById('adv_fontCssFamily').value = o.family || '';
      } catch {}
    });

    // try font preview
    document.getElementById('adv_tryFont').addEventListener('click', ()=>{
      const url = document.getElementById('adv_fontUrl').value.trim();
      const fam = document.getElementById('adv_fontCssFamily').value.trim() || 'system-ui';
      const tmp = Object.assign({}, state.values, { fontUrl:url, fontCssFamily:fam });
      applySettings(tmp);
      document.getElementById('adv_msg').textContent = '‡∏•‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
    });

    // upload logo
    document.getElementById('adv_uploadLogo').addEventListener('click', async ()=>{
      const msg = document.getElementById('adv_msg');
      const f = document.getElementById('adv_logoFile').files[0];
      if (!f) { alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      try {
        msg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ...';
        const res = await uploadSingleToAssets(f);
        state.values.logo = res;
        applySettings(state.values);
        const prev = document.getElementById('adv_logoPreview');
        prev.innerHTML = `<a href="${res.webViewLink}" target="_blank" class="text-blue-600 underline">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${res.name}</a>`;
        msg.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏î‡∏à‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
      } catch(e) {
        msg.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (e.message||e);
      }
    });

    // preview (not save)
    document.getElementById('adv_preview').addEventListener('click', ()=>{
      const v = collectValues();
      applySettings(Object.assign({}, state.values, v));
      document.getElementById('adv_msg').textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
    });

    // submit (save)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('adv_msg');
      try {
        const v = collectValues();
        await saveSettings(v);
        msg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî'; msg.className='text-xs text-green-600';
        setTimeout(()=> overlay.classList.add('hidden'), 500);
      } catch(err) {
        msg.textContent = (err.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); msg.className='text-xs text-red-600';
      }
    });

    function collectValues(){
      return {
        brandTitle: document.getElementById('adv_brandTitle').value.trim(),
        welcomeTitle: document.getElementById('adv_welcomeTitle').value.trim(),
        welcomeSubtext: document.getElementById('adv_welcomeSubtext').value.trim(),
        primaryColor: document.getElementById('adv_primaryColor').value,
        accentColor: document.getElementById('adv_accentColor').value,
        buttonRadius: parseInt(document.getElementById('adv_buttonRadius').value || '12', 10),
        darkDefault: document.getElementById('adv_darkDefault').checked,
        fontUrl: document.getElementById('adv_fontUrl').value.trim(),
        fontCssFamily: document.getElementById('adv_fontCssFamily').value.trim() || 'system-ui',
        hideWelcome: document.getElementById('adv_hideWelcome').checked,
        hideProfile: document.getElementById('adv_hideProfile').checked,
        hideCalculator: document.getElementById('adv_hideCalculator').checked,
        hideHistory: document.getElementById('adv_hideHistory').checked,
        logo: state.values.logo || null
      };
    }
  }

  // boot
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>{ loadSettings().then(mountUI); });
  } else {
    loadSettings().then(mountUI);
  }
  firebase.auth().onAuthStateChanged(()=>{ if (state.loaded) loadSettings(); });
})();
</script>

