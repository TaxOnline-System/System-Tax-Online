<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TaxOnline - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</title>

<!-- TailwindCSS -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf.js (HTML -> PDF ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢) -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<style>
  body {
    background: linear-gradient(-45deg, #e0c3fc, #8ec5fc, #fbc2eb, #a1c4fd);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
  }
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .fade-in { animation: fadeIn 0.7s ease-in; }
  @keyframes fadeIn { 0%{opacity:0; transform:translateY(10px);} 100%{opacity:1; transform:translateY(0);} }
  #splash {
    position: fixed; inset: 0; background:#fff; z-index:9999;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    opacity:1; transition: opacity 0.8s ease;
  }
  .splash-spinner {
    width:60px;height:60px;border:8px solid transparent;border-top-color:#ec4899;border-radius:50%;
    animation: spin 1.4s linear infinite;
  }
  @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
  .nav-link { display:inline-block; margin:0.25rem 0.4rem; }

  /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö html2pdf) */
  #pdfReport {
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", "TH Sarabun New", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    color: #111827;
  }
  #pdfReport h1 { font-size: 18pt; margin: 0 0 6pt 0; }
  #pdfReport h2 { font-size: 13pt; margin: 14pt 0 6pt 0; }
  #pdfReport .meta { font-size: 10pt; line-height: 1.4; }
  #pdfReport table { width: 100%; border-collapse: collapse; font-size: 10pt; }
  #pdfReport th, #pdfReport td { border: 1px solid #e5e7eb; padding: 6pt 8pt; }
  #pdfReport th { background: #eff6ff; text-align: left; }
  #pdfReport .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 6pt; font-size: 11pt; }
</style>
</head>
<body class="font-sans">

<!-- Splash -->
<div id="splash">
  <div class="splash-spinner"></div>
  <h2 class="text-xl font-semibold text-pink-600 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</h2>
</div>

<!-- Header -->
<header class="bg-white dark:bg-gray-900 shadow p-4 fixed w-full z-30 top-0">
  <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center">
    <div class="flex items-center gap-3 mb-2 sm:mb-0">
      <h1 class="text-2xl font-bold text-pink-600 dark:text-yellow-300">TaxOnline</h1>
      <span id="userGreeting" class="text-sm text-gray-600 dark:text-gray-300 hidden">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‚Ä¶</span>
    </div>
    <nav class="text-center sm:text-right">
      <button class="nav-link text-pink-600 dark:text-yellow-400 hover:underline font-semibold" data-nav="welcome">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="nav-link text-gray-700 dark:text-gray-200 hover:underline" data-nav="calculator">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</button>
      <button class="nav-link text-gray-700 dark:text-gray-200 hover:underline" data-nav="history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      <button class="nav-link text-gray-700 dark:text-gray-200 hover:underline" data-nav="profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
      <button id="loginNav" class="nav-link text-blue-600 dark:text-yellow-400 hover:underline font-semibold" data-nav="auth">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button id="logoutBtn" class="nav-link text-red-600 hover:underline hidden">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </nav>
  </div>
</header>

<!-- Time + Dark -->
<div class="fixed top-20 sm:top-4 left-4 z-50 bg-white dark:bg-gray-800 text-sm text-gray-700 dark:text-white px-3 py-1 rounded shadow">
  <span id="datetime">--:--</span>
</div>
<div class="fixed top-20 sm:top-4 right-4 z-50">
  <button id="darkToggle" class="bg-white dark:bg-gray-700 text-gray-700 dark:text-white px-4 py-2 rounded shadow text-sm font-medium">
    üåô Toggle Dark Mode
  </button>
</div>

<div class="pt-28 pb-16">

  <!-- Welcome -->
  <section id="welcomeSection" class="fade-in text-center px-6">
    <h2 class="text-3xl sm:text-4xl font-bold text-pink-700 dark:text-yellow-300 mb-4">
      ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏á‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ!
    </h2>
    <p class="text-gray-700 dark:text-gray-300 text-base sm:text-lg max-w-2xl mx-auto">
      ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ü‡∏£‡∏µ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢
    </p>
    <div class="mt-6 flex items-center justify-center gap-3 flex-wrap">
      <button class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="calculator">
        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏¢
      </button>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="auth" id="welcomeLoginBtn">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
      </button>
    </div>
  </section>

  <!-- Auth -->
  <section id="authSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl dark:bg-gray-900">
      <h2 class="text-2xl font-bold text-center text-pink-600 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

      <div class="flex justify-center space-x-4 mb-6">
        <button id="loginTab" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button id="signupTab" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full transition">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </div>

      <!-- Login -->
      <form id="loginForm" class="space-y-4 hidden">
        <input type="email" id="loginEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <input type="password" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>

      <!-- Signup -->
      <form id="signupForm" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
          <input type="text" id="signupFirstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
          <input type="text" id="signupLastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        </div>
        <input type="email" id="signupEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <input type="password" id="signupPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition" type="submit">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </form>

      <div class="mt-6 border-t pt-4">
        <button id="googleSignInBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold transition">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
        </button>
      </div>

      <p id="authMessage" class="text-red-500 text-center mt-4 text-sm"></p>
    </div>
  </section>

  <!-- Profile -->
  <section id="profileSection" class="hidden fade-in px-4">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl dark:bg-gray-900">
      <h3 class="text-2xl font-semibold text-pink-600 mb-4">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <form id="profileForm" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300">‡∏ä‡∏∑‡πà‡∏≠</label>
            <input id="profileFirstName" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white"/>
          </div>
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="profileLastName" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white"/>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="profileEmail" type="email" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white" disabled/>
          </div>
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
            <input id="profilePhone" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white"/>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
          <textarea id="profileAddress" rows="3" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white"></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
          <button type="button" id="reloadProfile" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <p id="profileMsg" class="text-sm mt-2"></p>
      </form>
    </div>
  </section>

  <!-- Calculator -->
  <section id="calculatorSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white dark:bg-gray-900 p-6 sm:p-8 rounded-2xl shadow-xl">
      <h3 class="text-xl sm:text-2xl font-semibold text-center text-blue-600 dark:text-purple-300 mb-4">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</h3>
      <form class="space-y-4" id="taxForm">
        <div>
          <label class="block text-sm font-medium text-gray-800 dark:text-gray-200">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="income" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800 dark:text-gray-200">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="expense" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800 dark:text-gray-200">‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="deduction" value="60000" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:text-white"/>
        </div>
        <div class="mb-4">
          <label for="receiptUpload" class="block text-sm font-medium text-gray-800 dark:text-gray-200">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
          <input type="file" id="receiptUpload" accept="image/*,.pdf" multiple
            class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-white dark:hover:file:bg-gray-600">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, PDF (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</p>
          <div id="fileInfo" class="mt-2 text-sm text-gray-700 dark:text-gray-300"></div>
          <div id="previewArea" class="mt-2 grid grid-cols-3 gap-2"></div>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</button>
      </form>
      <div class="mt-6"><canvas id="taxPieChart"></canvas></div>
      <p id="calcMsg" class="text-sm mt-3"></p>
    </div>
  </section>

  <!-- History -->
  <section id="historySection" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow-xl dark:bg-gray-900">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-4">
        <h3 class="text-2xl font-semibold text-pink-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>

        <div class="flex flex-wrap items-end gap-2">
          <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="histFrom" class="border rounded px-2 py-1 text-sm dark:bg-gray-800 dark:text-white">
          </div>
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="histTo" class="border rounded px-2 py-1 text-sm dark:bg-gray-800 dark:text-white">
          </div>

          <button id="refreshHistory" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button id="exportCsvBtn" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
          <button id="exportPdfBtn" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
        </div>
      </div>

      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left bg-gray-50 dark:bg-gray-800">
              <th class="px-3 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="px-3 py-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
              <th class="px-3 py-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
              <th class="px-3 py-2">‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô</th>
              <th class="px-3 py-2">‡∏†‡∏≤‡∏©‡∏µ</th>
              <th class="px-3 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <p id="historyMsg" class="text-sm mt-3"></p>
    </div>
  </section>

  <!-- HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á PDF (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) -->
  <section id="pdfReport" class="hidden bg-white p-6"></section>

</div>

<footer class="bg-white dark:bg-gray-900 p-4 text-center text-sm text-gray-500 dark:text-gray-400">
  &copy; 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ ‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ¬∑ ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
</footer>

<script>
  /* ========== Firebase Config & Init ========== */
  const firebaseConfig = {
    apiKey: "AIzaSyBl-j4STHVQ80VNM6mPl80-55BHk4nEyZk",
    authDomain: "tax-online-6afdd.firebaseapp.com",
    projectId: "tax-online-6afdd",
    storageBucket: "tax-online-6afdd.appspot.com",
    messagingSenderId: "959276043439",
    appId: "1:959276043439:web:f358ce055687efea5d185a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const storage = firebase.storage();

  /* ========== DOM ========== */
  const sections = {
    welcome: document.getElementById('welcomeSection'),
    auth: document.getElementById('authSection'),
    profile: document.getElementById('profileSection'),
    calculator: document.getElementById('calculatorSection'),
    history: document.getElementById('historySection')
  };
  const userGreeting = document.getElementById('userGreeting');
  const loginNav = document.getElementById('loginNav');
  const logoutBtn = document.getElementById('logoutBtn');
  const historyBody = document.getElementById('historyBody');
  const historyMsg = document.getElementById('historyMsg');
  const profileMsg = document.getElementById('profileMsg');
  const calcMsg = document.getElementById('calcMsg');

  /* ========== UI Helpers ========== */
  function showOnly(sectionKey) {
    Object.keys(sections).forEach(k => {
      sections[k].classList.toggle('hidden', k !== sectionKey);
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  document.querySelectorAll('[data-nav]').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-nav');
      if (target === 'calculator' || target === 'history' || target === 'profile') {
        if (!auth.currentUser) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ');
          showOnly('auth');
          return;
        }
      }
      if (target === 'history') loadHistory();
      if (target === 'profile') loadProfile();
      showOnly(target);
    });
  });

  document.getElementById('darkToggle').addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
  });
  (function () {
    if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
  })();

  function updateDateTime() {
    const now = new Date();
    const options = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
    const timeStr = now.toLocaleTimeString('th-TH');
    const dateStr = now.toLocaleDateString('th-TH', options);
    const el = document.getElementById('datetime');
    if (el) el.innerText = `${dateStr} ${timeStr}`;
  }
  setInterval(updateDateTime, 1000); updateDateTime();

  window.addEventListener('load', () => {
    setTimeout(() => {
      const s = document.getElementById('splash');
      s.style.opacity = '0';
      setTimeout(() => s.style.display = 'none', 800);
    }, 1200);
    showOnly('welcome');
  });

  /* ========== Auth ========== */
  const loginTab = document.getElementById('loginTab');
  const signupTab = document.getElementById('signupTab');
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  const authMessage = document.getElementById('authMessage');

  loginTab.addEventListener('click', () => {
    loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); authMessage.textContent = '';
  });
  signupTab.addEventListener('click', () => {
    signupForm.classList.remove('hidden'); loginForm.classList.add('hidden'); authMessage.textContent = '';
  });
  loginTab.click();

  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email, password)
      .then(() => { showOnly('calculator'); })
      .catch(err => { authMessage.textContent = err.message; console.error(err); });
  });

  signupForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const firstName = document.getElementById('signupFirstName').value.trim();
    const lastName = document.getElementById('signupLastName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    if (!firstName || !lastName || !email || !password) {
      authMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á'; return;
    }
    auth.createUserWithEmailAndPassword(email, password)
      .then(cred => {
        const user = cred.user;
        return user.updateProfile({ displayName: `${firstName} ${lastName}` })
          .then(() => db.collection('users').doc(user.uid).set({
            uid: user.uid,
            firstName, lastName, email,
            phone: '', address: '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true }));
      })
      .then(() => { showOnly('profile'); loadProfile(); })
      .catch(err => { authMessage.textContent = err.message; console.error(err); });
  });

  document.getElementById('googleSignInBtn').addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(async (res) => {
        const user = res.user;
        const docRef = db.collection('users').doc(user.uid);
        const snap = await docRef.get();
        if (!snap.exists) {
          const [firstName, ...rest] = (user.displayName || '').split(' ');
          await docRef.set({
            uid: user.uid,
            firstName: firstName || '',
            lastName: (rest || []).join(' ') || '',
            email: user.email || '',
            phone: '', address: '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }
        showOnly('calculator');
      })
      .catch(err => { authMessage.textContent = err.message; console.error(err); });
  });

  logoutBtn.addEventListener('click', () => { auth.signOut(); });

  auth.onAuthStateChanged((user) => {
    if (user) {
      userGreeting.classList.remove('hidden');
      userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${user.displayName || user.email}`;
      loginNav.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
    } else {
      userGreeting.classList.add('hidden');
      loginNav.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      showOnly('welcome');
    }
  });

  /* ========== Profile Load/Save ========== */
  const profileForm = document.getElementById('profileForm');
  const profileFirstName = document.getElementById('profileFirstName');
  const profileLastName = document.getElementById('profileLastName');
  const profileEmail = document.getElementById('profileEmail');
  const profilePhone = document.getElementById('profilePhone');
  const profileAddress = document.getElementById('profileAddress');
  document.getElementById('reloadProfile').addEventListener('click', loadProfile);

  async function loadProfile() {
    profileMsg.textContent = '';
    const user = auth.currentUser;
    if (!user) { profileMsg.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; profileMsg.className='text-red-600 text-sm mt-2'; return; }
    try {
      const snap = await db.collection('users').doc(user.uid).get();
      if (snap.exists) {
        const data = snap.data();
        profileFirstName.value = data.firstName || '';
        profileLastName.value = data.lastName || '';
        profileEmail.value = data.email || user.email || '';
        profilePhone.value = data.phone || '';
        profileAddress.value = data.address || '';
        profileMsg.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        profileMsg.className = 'text-green-600 text-sm mt-2';
      } else {
        profileFirstName.value = user.displayName ? user.displayName.split(' ')[0] : '';
        profileLastName.value = user.displayName ? user.displayName.split(' ').slice(1).join(' ') : '';
        profileEmail.value = user.email || '';
        profileMsg.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
        profileMsg.className = 'text-yellow-600 text-sm mt-2';
      }
    } catch (e) {
      console.error(e);
      profileMsg.textContent = e.message;
      profileMsg.className = 'text-red-600 text-sm mt-2';
    }
  }

  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); showOnly('auth'); return; }
    try {
      await db.collection('users').doc(user.uid).set({
        uid: user.uid,
        firstName: profileFirstName.value.trim(),
        lastName: profileLastName.value.trim(),
        email: profileEmail.value.trim() || user.email,
        phone: profilePhone.value.trim(),
        address: profileAddress.value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      const displayName = `${profileFirstName.value.trim()} ${profileLastName.value.trim()}`.trim();
      await user.updateProfile({ displayName });
      userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${displayName || user.email}`;

      profileMsg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      profileMsg.className = 'text-green-600 text-sm mt-2';
    } catch (e) {
      console.error(e);
      profileMsg.textContent = e.message;
      profileMsg.className = 'text-red-600 text-sm mt-2';
    }
  });

  /* ========== Upload Preview (client only) ========== */
  document.getElementById('receiptUpload').addEventListener('change', function(){
    const files = this.files;
    const fileInfo = document.getElementById('fileInfo');
    const previewArea = document.getElementById('previewArea');
    fileInfo.innerText = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${files.length} ‡πÑ‡∏ü‡∏•‡πå`;
    previewArea.innerHTML = '';
    Array.from(files).forEach(file => {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = file.name;
          img.className = 'w-full h-24 object-cover rounded shadow';
          previewArea.appendChild(img);
        };
        reader.readAsDataURL(file);
      } else {
        const p = document.createElement('p');
        p.textContent = `üìÑ ${file.name}`;
        p.className = 'text-xs text-gray-700 dark:text-gray-300';
        previewArea.appendChild(p);
      }
    });
  });

  /* ========== Tax Calculator + Save + Upload Receipts ========== */
  function calculateTax(income, expense, deduction) {
    const net = income - expense - deduction;
    return net <= 150000 ? 0 : net * 0.05; // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  }

  document.getElementById('taxForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const income = Number(document.getElementById('income').value);
    const expense = Number(document.getElementById('expense').value);
    const deduction = Number(document.getElementById('deduction').value);
    const fileInput = document.getElementById('receiptUpload');
    const files = fileInput?.files || [];

    if (Number.isNaN(income) || Number.isNaN(expense) || Number.isNaN(deduction)) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç'); return;
    }

    const tax = Number(calculateTax(income, expense, deduction)) || 0;

    // Pie
    const ctx = document.getElementById('taxPieChart').getContext('2d');
    if (window.taxChart instanceof Chart) window.taxChart.destroy();
    const needTax = (income - expense - deduction) > 150000 ? 100 : 0;
    window.taxChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ', '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ'],
        datasets: [{ data: [needTax, 100 - needTax], backgroundColor: ['#ef4444','#22c55e'], hoverOffset: 4 }]
      },
      options: { responsive: true, plugins: { legend: { position:'top' }, title: { display:true, text:`‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${tax.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó` } } }
    });

    calcMsg.textContent = '';

    // ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ
    const user = auth.currentUser;
    if (!user) {
      calcMsg.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ / ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå';
      calcMsg.className = 'text-yellow-600 text-sm mt-3';
      return;
    }

    try {
      // 1) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ receipts)
      const docRef = await db.collection('users').doc(user.uid).collection('calculations').add({
        income: income || 0,
        expense: expense || 0,
        deduction: deduction || 0,
        tax: tax || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        receipts: []
      });

      // 2) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      let uploaded = [];
      if (files.length > 0) {
        const storageRef = storage.ref();
        const tasks = Array.from(files).map(async (file) => {
          const safeName = `${Date.now()}_${file.name}`.replace(/[^\w.\-]/g, '_');
          const path = `users/${user.uid}/calculations/${docRef.id}/${safeName}`;
          const snap = await storageRef.child(path).put(file, {
            contentType: file.type || 'application/octet-stream',
            customMetadata: { originalName: file.name }
          });
          const url = await snap.ref.getDownloadURL();
          return { name: file.name, size: file.size || null, type: file.type || null, url, path };
        });
        uploaded = await Promise.all(tasks);
      }

      // 3) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
      if (uploaded.length) await docRef.update({ receipts: uploaded });

      // 4) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•
      if (fileInput) fileInput.value = '';
      calcMsg.textContent = uploaded.length
        ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (${uploaded.length} ‡πÑ‡∏ü‡∏•‡πå)`
        : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß';
      calcMsg.className = 'text-green-600 text-sm mt-3';

    } catch (e) {
      console.error('Save calc/upload failed:', e);
      calcMsg.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.code || ''} ${e.message || ''}`;
      calcMsg.className = 'text-red-600 text-sm mt-3';
    }
  });

  /* ========== History (Filter/Export/Delete) ========== */
  let _lastHistoryRows = []; // cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å [{id,date,income,expense,deduction,tax,receipts}]
  const fmtTH = (n) => (Number(n) || 0).toLocaleString('th-TH');
  const toYMD = (d) => {
    const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };

  async function loadHistory() {
    historyMsg.textContent = '';
    historyBody.innerHTML = '';
    _lastHistoryRows = [];
    const user = auth.currentUser;
    if (!user) { historyMsg.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; historyMsg.className='text-red-600'; return; }

    try {
      const fromEl = document.getElementById('histFrom');
      const toEl   = document.getElementById('histTo');
      const hasFrom = fromEl && fromEl.value;
      const hasTo   = toEl && toEl.value;

      let ref = db.collection('users').doc(user.uid).collection('calculations');

      // filter by date range if provided
      if (hasFrom) {
        const fromDate = new Date(fromEl.value + 'T00:00:00');
        ref = ref.where('createdAt','>=', firebase.firestore.Timestamp.fromDate(fromDate));
      }
      if (hasTo) {
        const toDateEnd = new Date(toEl.value + 'T23:59:59');
        ref = ref.where('createdAt','<=', firebase.firestore.Timestamp.fromDate(toDateEnd));
      }

      ref = ref.orderBy('createdAt','desc').limit(500);
      const snap = await ref.get();

      if (snap.empty) {
        historyBody.innerHTML = `<tr><td colspan="6" class="px-3 py-3 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }

      snap.forEach(doc => {
        const d = doc.data();
        const dt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : new Date();
        const row = {
          id: doc.id,
          date: dt,
          income: Number(d.income)||0,
          expense: Number(d.expense)||0,
          deduction: Number(d.deduction)||0,
          tax: Number(d.tax)||0,
          receipts: Array.isArray(d.receipts) ? d.receipts : []
        };
        _lastHistoryRows.push(row);

        const nFiles = row.receipts.length;
        const filesLinks = nFiles
          ? row.receipts.map((r, i) => `<a href="${r.url}" target="_blank" class="text-blue-600 hover:underline">‡πÑ‡∏ü‡∏•‡πå ${i+1}</a>`).join(' ¬∑ ')
          : '<span class="text-gray-400">‚Äî</span>';

        const tr = document.createElement('tr');
        tr.className = 'border-b dark:border-gray-700';
        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap">${dt.toLocaleString('th-TH')}</td>
          <td class="px-3 py-2 whitespace-nowrap">${fmtTH(row.income)}</td>
          <td class="px-3 py-2 whitespace-nowrap">${fmtTH(row.expense)}</td>
          <td class="px-3 py-2 whitespace-nowrap">${fmtTH(row.deduction)}</td>
          <td class="px-3 py-2 whitespace-nowrap font-semibold">${fmtTH(row.tax)}</td>
          <td class="px-3 py-2 space-y-1">
            <button data-del="${doc.id}" class="text-red-600 hover:underline text-xs">‡∏•‡∏ö</button>
            <div class="text-xs">${filesLinks}</div>
          </td>
        `;
        historyBody.appendChild(tr);
      });

      // delete buttons
      historyBody.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
          try {
            // ‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            const user = auth.currentUser;
            const calcId = btn.getAttribute('data-del');
            await db.collection('users').doc(user.uid).collection('calculations').doc(calcId).delete();
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Storage ‡∏î‡πâ‡∏ß‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á path ‡∏à‡∏≤‡∏Å receipts ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢ storage.ref(path).delete()
            loadHistory();
          } catch (e) {
            console.error(e);
            alert(e.message);
          }
        });
      });

    } catch (e) {
      console.error(e);
      historyMsg.textContent = e.message;
      historyMsg.className = 'text-red-600';
    }
  }
  document.getElementById('refreshHistory').addEventListener('click', loadHistory);

  /* ====== Export: CSV & PDF ====== */
  function exportHistoryCSV() {
    if (!_lastHistoryRows.length) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡πà‡∏≠‡∏ô)'); return; }

    const sum = _lastHistoryRows.reduce((acc, r) => {
      acc.income += r.income; acc.expense += r.expense; acc.deduction += r.deduction; acc.tax += r.tax; return acc;
    }, {income:0, expense:0, deduction:0, tax:0});

    const u = auth.currentUser;
    const displayName = u?.displayName || '';
    const email = u?.email || '';

    const header = ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ','‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢','‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô','‡∏†‡∏≤‡∏©‡∏µ','‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö'];
    const rows = _lastHistoryRows
      .slice().sort((a,b)=> a.date - b.date)
      .map(r => [
        r.date.toLocaleString('th-TH'),
        r.income,
        r.expense,
        r.deduction,
        r.tax,
        (r.receipts||[]).map(f=>f.url).join(' | ')
      ]);

    rows.push([]);
    rows.push(['‡∏£‡∏ß‡∏°', sum.income, sum.expense, sum.deduction, sum.tax, '']);
    rows.push([]);
    rows.push(['‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô', displayName]);
    rows.push(['‡∏≠‡∏µ‡πÄ‡∏°‡∏•', email]);

    const csv = [header, ...rows].map(line =>
      line.map(v => {
        const s = String(v ?? '');
        return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')
    ).join('\n');

    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    const today = toYMD(new Date()).replace(/-/g,'');
    a.href = URL.createObjectURL(blob);
    a.download = `TaxOnline_History_${today}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportHistoryPDF() {
    if (!_lastHistoryRows.length) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡πà‡∏≠‡∏ô)'); return; }

    const u = auth.currentUser;
    const displayName = u?.displayName || '-';
    const email = u?.email || '-';
    const printedAt = new Date().toLocaleString('th-TH');

    const sum = _lastHistoryRows.reduce((acc, r) => {
      acc.income += r.income; acc.expense += r.expense; acc.deduction += r.deduction; acc.tax += r.tax; return acc;
    }, {income:0, expense:0, deduction:0, tax:0});

    const bodyRows = _lastHistoryRows
      .slice().sort((a,b)=> a.date - b.date)
      .map(r => `
        <tr>
          <td>${r.date.toLocaleString('th-TH')}</td>
          <td style="text-align:right">${fmtTH(r.income)}</td>
          <td style="text-align:right">${fmtTH(r.expense)}</td>
          <td style="text-align:right">${fmtTH(r.deduction)}</td>
          <td style="text-align:right">${fmtTH(r.tax)}</td>
        </tr>
      `).join('');

    const report = document.getElementById('pdfReport');
    report.innerHTML = `
      <div>
        <h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ (TaxOnline)</h1>
        <div class="meta">
          ‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${escapeHtml(displayName)}<br/>
          ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${escapeHtml(email)}<br/>
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${escapeHtml(printedAt)}
        </div>

        <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h2>
        <div class="summary">
          <div>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°: <strong>${fmtTH(sum.income)}</strong> ‡∏ö‡∏≤‡∏ó</div>
          <div>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <strong>${fmtTH(sum.expense)}</strong> ‡∏ö‡∏≤‡∏ó</div>
          <div>‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°: <strong>${fmtTH(sum.deduction)}</strong> ‡∏ö‡∏≤‡∏ó</div>
          <div>‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°: <strong>${fmtTH(sum.tax)}</strong> ‡∏ö‡∏≤‡∏ó</div>
        </div>

        <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
        <table>
          <thead>
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th style="text-align:right">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
              <th style="text-align:right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
              <th style="text-align:right">‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô</th>
              <th style="text-align:right">‡∏†‡∏≤‡∏©‡∏µ</th>
            </tr>
          </thead>
          <tbody>
            ${bodyRows}
          </tbody>
        </table>
      </div>
    `;
    report.classList.remove('hidden');

    const opt = {
      margin:       [10, 12, 10, 12],
      filename:     `TaxOnline_History_${toYMD(new Date()).replace(/-/g,'')}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'pt', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(report).set(opt).save().then(() => {
      report.classList.add('hidden');
      report.innerHTML = '';
    });
  }

  function escapeHtml(str) {
    return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  document.getElementById('exportCsvBtn').addEventListener('click', exportHistoryCSV);
  document.getElementById('exportPdfBtn').addEventListener('click', exportHistoryPDF);
</script>
</body>
</html>
