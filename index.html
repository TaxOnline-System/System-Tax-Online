async function exportHistoryPDF() {
  try {
    const rows = await fetchAllCalculations();
    const { jsPDF } = window.jspdf || {};
    if (!rows || !rows.length) { alert('ยังไม่มีข้อมูลประวัติ'); return; }
    if (!jsPDF || !('autoTable' in (new jsPDF()))) {
      alert('ไม่พบ jsPDF หรือปลั๊กอิน autoTable'); return;
    }

    // --------- เพิ่ม: รอฝังฟอนต์ไทยก่อน ----------
    await ensureThaiFont();
    const FONT = 'NotoSansThai';

    // สรุปรวม
    let sumIncome=0,sumExpense=0,sumDeduct=0,sumNet=0;
    rows.forEach(r=>{
      const e=computeExpenseUsed(r);
      sumIncome+=r.income||0; sumExpense+=e; sumDeduct+=r.deduction||0;
      sumNet+=Math.max(0,(r.income||0)-e-(r.deduction||0));
    });
    const sumTax = thaiProgressiveTax(sumNet);

    const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });

    // --------- เพิ่ม: ตั้งฟอนต์ไทยเป็นค่าเริ่มต้น ----------
    doc.setFont(FONT, 'normal');
    doc.setFontSize(16);
    doc.text('สรุปประวัติและภาษีรวม (TaxOnline)', 10, 14);
    doc.setFontSize(10);
    const u = auth && auth.currentUser; 
    doc.text(`ผู้ใช้: ${u ? (u.displayName || u.email) : '-'}`, 10, 20);
    doc.text(`พิมพ์เมื่อ: ${new Date().toLocaleString('th-TH')}`, 10, 26);

    doc.setFontSize(11);
    doc.text(`รายได้รวม: ${sumIncome.toLocaleString('th-TH')}  รายจ่ายรวม: ${sumExpense.toLocaleString('th-TH')}  ลดหย่อนรวม: ${sumDeduct.toLocaleString('th-TH')}`, 10, 34);
    doc.text(`เงินได้สุทธิ: ${sumNet.toLocaleString('th-TH')}  ภาษีรวม (ประมาณ): ${sumTax.toLocaleString('th-TH')}`, 10, 40);

    const head = [['วันที่','รายได้','วิธีรายจ่าย','รายจ่ายใช้คำนวณ','ลดหย่อน','สุทธิ','ใบเสร็จ']];
    const body = rows.map((r) => {
      const expUsed = computeExpenseUsed(r);
      const net = Math.max(0, (r.income||0) - expUsed - (r.deduction||0));
      return [
        r.date || '',
        (r.income ?? 0).toLocaleString('th-TH'),
        r.expenseMethod==='lumpsum'
          ? `เหมาจ่าย ${r.lumpsumPercent||''}%${r.lumpsumCap?` (เพดาน ${(r.lumpsumCap).toLocaleString('th-TH')})`:''}`
          : 'ตามจริง',
        expUsed.toLocaleString('th-TH'),
        (r.deduction ?? 0).toLocaleString('th-TH'),
        net.toLocaleString('th-TH'),
        (r.receipts && r.receipts.length) ? r.receipts.map((x,i)=>`ไฟล์ ${i+1}`).join(' , ') : '—'
      ];
    });

    doc.autoTable({
      head, body,
      startY: 46,
      styles: { font: FONT, fontSize: 9, cellPadding: 2 }, // <-- ให้ autoTable ใช้ฟอนต์ไทย
      headStyles: { fillColor: [243,244,246], textColor: 0, font: FONT, fontStyle: 'normal' },
      columnStyles: { 0:{cellWidth:32}, 1:{cellWidth:26}, 2:{cellWidth:40}, 3:{cellWidth:26}, 4:{cellWidth:26}, 5:{cellWidth:26}, 6:{cellWidth:'auto'} },
      didDrawPage: () => {
        const pageCount = doc.internal.getNumberOfPages();
        const str = `หน้า ${doc.internal.getCurrentPageInfo().pageNumber} / ${pageCount}`;
        doc.setFont(FONT, 'normal');
        doc.setFontSize(9);
        doc.text(str, 200 - doc.getTextWidth(str) - 10, 291);
      }
    });

    // --------- ปรับ “ลิงก์ใบเสร็จ” ให้เป็นป้ายสั้น + ลิงก์คลิกได้ ----------
    let y = doc.lastAutoTable.finalY + 6;
    const linkItems = [];
    rows.forEach((r, idx) => {
      (r.receipts || []).forEach((x, i) => {
        if (x.webViewLink) linkItems.push({ label: `แถว ${idx + 1} → ไฟล์ ${i + 1}`, url: x.webViewLink });
      });
    });

    if (linkItems.length) {
      doc.setFont(FONT, 'normal');
      doc.setFontSize(11);
      doc.text('ลิงก์ใบเสร็จ (คลิกได้):', 10, y);
      y += 6;
      doc.setFontSize(10);

      const xLeft = 10, gapY = 6;
      linkItems.forEach(item => {
        // พิมพ์เป็นข้อความสั้น แล้วผูกลิงก์แทนการแสดง URL ยาวๆ
        doc.textWithLink(item.label, xLeft, y, { url: item.url });
        y += gapY;
        if (y > 280) { doc.addPage(); doc.setFont(FONT, 'normal'); y = 14; }
      });
    }

    doc.save('taxonline_summary.pdf');
  } catch (e) {
    console.error(e);
    alert(e.message || e);
  }
}
