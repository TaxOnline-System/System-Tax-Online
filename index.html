<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TaxOnline - ระบบเว็บไซต์คำนวณภาษีสำหรับพ่อค้า แม่ค้าออนไลน์ </title>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<!-- Chart.js (เผื่ออนาคต) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF + autoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<!-- html2canvas (ยังคงโหลดไว้ แต่ “ไม่ใช้” สำหรับสรุปภาษี) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Google Identity Services (OAuth 2.0 for Drive) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body{background:linear-gradient(-45deg,#e0c3fc,#8ec5fc,#fbc2eb,#a1c4fd);background-size:400% 400%;animation:gradientBG 15s ease infinite}
  @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .fade-in{animation:fadeIn .7s ease-in}@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
  #splash{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:1;transition:opacity .8s ease}
  .splash-spinner{width:60px;height:60px;border:8px solid transparent;border-top-color:#ec4899;border-radius:50%;animation:spin 1.4s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .nav-link{display:inline-block;margin:.25rem .4rem}
  #diag{font-family:ui-monospace,Menlo,Consolas,monospace}

  /* พื้นที่โคลนเวลาแคปเจอร์ (เผื่อใช้ในหน้าอื่น) */
  #print-clone-host{ position: fixed; left: -10000px; top: 0; width: 1000px; background: #fff; }

  @media print {
    body { animation: none !important; }
    #splash, header, footer, .fixed { display: none !important; }
  }
</style>
</head>
<body class="font-sans">

<!-- Splash -->
<div id="splash">
  <div class="splash-spinner"></div>
  <h2 class="text-xl font-semibold text-pink-600 mt-4">กำลังโหลดระบบ...</h2>
</div>

<!-- Header -->
<header class="bg-white shadow p-4 fixed w-full z-30 top-0">
  <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center">
    <div class="flex items-center gap-3 mb-2 sm:mb-0">
      <h1 class="text-2xl font-bold text-pink-600">TaxOnline Vers 0.2 </h1>
      <span id="userGreeting" class="text-sm text-gray-600 hidden">สวัสดี, …</span>
    </div>
    <nav class="text-center sm:text-right">
      <button class="nav-link text-pink-600 hover:underline font-semibold" data-nav="welcome">หน้าแรก</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="calculator">บันทึกรายการ</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="history">คำนวณภาษี</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="profile">โปรไฟล์</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="guide">คู่มือใช้งาน</button>
      <button id="loginNav" class="nav-link text-blue-600 hover:underline font-semibold" data-nav="auth">เข้าสู่ระบบ</button>
      <button id="logoutBtn" class="nav-link text-red-600 hover:underline hidden">ออกจากระบบ</button>
    </nav>
  </div>
</header>

<!-- Time + Drive status -->
<div class="fixed top-20 sm:top-4 left-4 z-50 bg-white text-sm text-gray-700 px-3 py-1 rounded shadow">
  <span id="datetime">--:--</span>
</div>
<div class="fixed top-20 sm:top-4 right-4 z-50 flex gap-2">
  <button id="driveConnectBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm font-medium">เชื่อมต่อ Google Drive</button>
  <span id="driveStatus" class="bg-white text-gray-700 px-3 py-2 rounded shadow text-sm">ยังไม่เชื่อมต่อ</span>
</div>

<div class="pt-28 pb-16">

  <!-- Welcome -->
  <section id="welcomeSection" class="fade-in text-center px-6">
    <h2 class="text-3xl sm:text-4xl font-bold text-pink-700 mb-4">ระบบเว็บไซต์คำนวณภาษีสำหรับพ่อค้า แม่ค้าออนไลน์</h2>
    <p class="text-gray-700 text-base sm:text-lg max-w-2xl mx-auto">
      เพิ่มรายการรายได้/รายจ่าย/ลดหย่อนในหน้า <b>บันทึกรายการ</b> และไปคำนวณภาษีรวมทั้งหมดในหน้า <b>คำนวณภาษี</b>
    </p>
    <div class="mt-6 flex items-center justify-center gap-3 flex-wrap">
      <button class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="calculator">เริ่มบันทึกรายการ</button>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="auth" id="welcomeLoginBtn">เข้าสู่ระบบ / สมัครสมาชิก</button>
      <button class="bg-white hover:bg-gray-50 text-gray-700 px-6 py-3 rounded-full text-lg shadow transition border" data-nav="guide">อ่านคู่มือ</button>
    </div>
  </section>

  <!-- Auth -->
  <section id="authSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl">
      <h2 class="text-2xl font-bold text-center text-pink-600 mb-6">เข้าสู่ระบบ / สมัครสมาชิก</h2>

      <div class="flex justify-center space-x-4 mb-6">
        <button id="loginTab" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full">เข้าสู่ระบบ</button>
        <button id="signupTab" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full">สมัครสมาชิก</button>
      </div>

      <!-- Login -->
      <form id="loginForm" class="space-y-4 hidden">
        <input type="email" id="loginEmail" placeholder="อีเมล" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <input type="password" id="loginPassword" placeholder="รหัสผ่าน" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold" type="submit">เข้าสู่ระบบ</button>
      </form>

      <!-- Signup -->
      <form id="signupForm" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
          <input type="text" id="signupFirstName" placeholder="ชื่อ" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
          <input type="text" id="signupLastName" placeholder="นามสกุล" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        </div>
        <input type="email" id="signupEmail" placeholder="อีเมล" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <input type="password" id="signupPassword" placeholder="รหัสผ่าน" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold" type="submit">สมัครสมาชิก</button>
      </form>

      <div class="mt-6 border-t pt-4">
        <button id="googleSignInBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
          เข้าสู่ระบบด้วย Google (Firebase Auth)
        </button>
      </div>

      <p id="authMessage" class="text-red-500 text-center mt-4 text-sm"></p>
    </div>
  </section>

  <!-- Profile -->
  <section id="profileSection" class="hidden fade-in px-4">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-2xl font-semibold text-pink-600 mb-4">โปรไฟล์ผู้ใช้งาน</h3>
      <form id="profileForm" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700">ชื่อ</label>
            <input id="profileFirstName" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
          <div>
            <label class="block text-sm text-gray-700">นามสกุล</label>
            <input id="profileLastName" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700">อีเมล</label>
            <input id="profileEmail" type="email" class="w-full p-2 border rounded-lg" disabled/>
          </div>
          <div>
            <label class="block text-sm text-gray-700">เบอร์โทร</label>
            <input id="profilePhone" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-700">ที่อยู่</label>
          <textarea id="profileAddress" rows="3" class="w-full p-2 border rounded-lg"></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold">บันทึกโปรไฟล์</button>
          <button type="button" id="reloadProfile" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg">โหลดข้อมูล</button>
        </div>
        <p id="profileMsg" class="text-sm mt-2"></p>
      </form>
    </div>
  </section>

  <!-- Calculator -->
  <section id="calculatorSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
      <h3 class="text-xl sm:text-2xl font-semibold text-center text-blue-600 mb-4">บันทึกรายการรายได้/รายจ่าย/ลดหย่อน</h3>
      <form class="space-y-4" id="recordForm">
        <div>
          <label class="block text-sm font-medium text-gray-800">รายได้ครั้งนี้ (บาท)</label>
          <input type="number" id="rec_income" class="w-full p-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800">รายจ่ายตามจริง (บาท)</label>
          <input type="number" id="rec_expense" class="w-full p-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800">ค่าลดหย่อนครั้งนี้ (บาท)</label>
          <input type="number" id="rec_deduction" value="60000" class="w-full p-2 border rounded-lg"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-800">อัปโหลดใบเสร็จ (อัปขึ้น Google Drive ของคุณ)</label>
          <input type="file" id="receiptUpload" accept="image/*,.pdf" multiple
                 class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
          <p class="mt-1 text-xs text-gray-500">รองรับ JPG, PNG, PDF (อัปโหลดหลายไฟล์)</p>
          <div id="fileInfo" class="mt-2 text-sm text-gray-700"></div>
          <div id="previewArea" class="mt-2 grid grid-cols-3 gap-2"></div>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition">บันทึกรายการ</button>
      </form>
      <p id="saveMsg" class="text-sm mt-3"></p>
    </div>
  </section>

  <!-- History -->
  <section id="historySection" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-semibold text-pink-600">คำนวณภาษีจากประวัติ</h3>
        <div class="flex gap-2">
          <button id="refreshHistory" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">รีเฟรช</button>
          <button id="downloadCsvBtn" class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm">ดาวน์โหลด CSV</button>
          <button id="downloadPdfBtn" class="px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-sm">ดาวน์โหลดสรุป PDF</button>
          <button id="openDriveFolderBtn" class="px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg text-sm">เปิดโฟลเดอร์ Drive</button>
        </div>
      </div>

      <!-- วิธีรายจ่ายรวม + ตัดซ้ำ -->
      <div id="methodPanel" class="mb-4 p-4 rounded-xl bg-white border text-sm grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <div class="font-medium text-gray-800 mb-1">วิธีคิดรายจ่ายรวม (ใช้กับการคำนวณทั้งหมด)</div>
          <label class="inline-flex items-center gap-2 mr-4"><input type="radio" name="sumExpenseMethod" value="actual" checked> ตามจริง</label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="sumExpenseMethod" value="lumpsum"> เหมาจ่าย</label>

          <div id="sumLumpsumConfig" class="grid grid-cols-2 gap-3 mt-3 hidden">
            <div>
              <label class="block text-xs text-gray-500">อัตราเหมาจ่าย (%)</label>
              <input type="number" id="sumLumpsumPercent" value="50" class="w-full p-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-xs text-gray-500">เพดานเหมาจ่าย (บาท) <span class="text-gray-400">(ไม่บังคับ)</span></label>
              <input type="number" id="sumLumpsumCap" placeholder="เช่น 100000" class="w-full p-2 border rounded-lg">
            </div>
          </div>
        </div>

        <div class="md:col-span-1">
          <label class="inline-flex items-center gap-2 mt-1">
            <input type="checkbox" id="dedupeToggle" checked>
            ตัดรายการที่ซ้ำ (ใช้รวม/ส่งออก)
          </label>
        </div>
      </div>

      <!-- สรุปรวม -->
      <div id="summaryPanel" class="mb-4 p-4 rounded-xl bg-gray-50 grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
        <div>
          <div class="text-gray-500">รายได้รวม</div>
          <div id="sumIncome" class="text-xl font-semibold">—</div>
        </div>
        <div>
          <div class="text-gray-500">รายจ่ายรวม (ตามวิธีที่เลือก)</div>
          <div id="sumExpense" class="text-xl font-semibold">—</div>
        </div>
        <div>
          <div class="text-gray-500">ลดหย่อนรวม</div>
          <div id="sumDeduct" class="text-xl font-semibold">—</div>
        </div>
        <div>
          <div class="text-gray-500">ภาษีที่ต้องชำระ (ประมาณ)</div>
          <div id="sumTax" class="text-2xl font-bold text-red-600">—</div>
        </div>
      </div>

      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left bg-gray-50">
              <th class="px-3 py-2">วันที่</th>
              <th class="px-3 py-2">รายได้</th>
              <th class="px-3 py-2">รายจ่ายใช้คำนวณ</th>
              <th class="px-3 py-2">ลดหย่อน</th>
              <th class="px-3 py-2">สุทธิ (ต่อรายการ)</th>
              <th class="px-3 py-2">ไฟล์</th>
              <th class="px-3 py-2">ลบ</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <p id="historyMsg" class="text-sm mt-3"></p>
    </div>
  </section>

  <!-- Guide -->
  <section id="guideSection" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between gap-3">
        <h3 class="text-2xl font-semibold text-pink-600">คู่มือการใช้งานระบบ TaxOnline</h3>
        <a
          id="downloadGuidePdfBtn"
          href="https://drive.google.com/file/d/1Idi6tDGyHwteXrs6a0WaRw1aXDDEW4bE/view?usp=drive_link"
          target="_blank" rel="noopener"
          class="px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-sm"
        >ดาวน์โหลดคู่มือ (Drive)</a>
      </div>

      <p class="mt-2 text-gray-600 text-sm">อัปเดต: 2025</p>

      <div class="mt-6 space-y-8 text-gray-800 leading-relaxed">

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">1) ภาพรวมระบบ</h4>
          <ul class="list-disc ml-5 space-y-1">
            <li><b>บันทึกรายการ</b> รายได้/รายจ่าย/ลดหย่อน พร้อมแนบใบเสร็จขึ้น Google Drive ส่วนตัวของคุณ</li>
            <li><b>คำนวณภาษี</b> รวมทุกบันทึก เลือกวิธีคิดรายจ่าย (ตามจริง/เหมาจ่าย) และตัดรายการซ้ำ</li>
            <li><b>โปรไฟล์</b> จัดการข้อมูลส่วนตัว (ชื่อ-ที่อยู่-โทรศัพท์)</li>
            <li><b>ส่งออก</b> ประวัติเป็น CSV หรือสรุปเป็น PDF</li>
          </ul>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">2) ก่อนเริ่มใช้งาน</h4>
          <ol class="list-decimal ml-5 space-y-2">
            <li>เปิดเว็บด้วย Chrome/Edge เวอร์ชันล่าสุด เพื่อประสิทธิภาพสูงสุด</li>
            <li>สมัคร/เข้าสู่ระบบ (อีเมล+รหัสผ่าน หรือ Google)</li>
            <li>เชื่อมต่อ Google Drive โดยกดปุ่ม <b>“เชื่อมต่อ Google Drive”</b> ที่มุมขวาบน</li>
          </ol>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">3) การใช้งานพื้นฐาน</h4>
          <div class="space-y-3">
            <div>
              <p class="font-medium">3.1 เข้าสู่ระบบ/สมัครสมาชิก</p>
              <ul class="list-disc ml-5">
                <li>หน้า <b>เข้าสู่ระบบ</b> เลือกแท็บ “เข้าสู่ระบบ” หรือ “สมัครสมาชิก”</li>
                <li>กด <b>“เข้าสู่ระบบด้วย Google”</b> ได้หากต้องการความสะดวก</li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.2 จัดการโปรไฟล์</p>
              <ul class="list-disc ml-5">
                <li>ไปที่เมนู <b>โปรไฟล์</b> แก้ไขชื่อ-ที่อยู่-โทรศัพท์ แล้วกด <b>บันทึกโปรไฟล์</b></li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.3 บันทึกรายการ</p>
              <ul class="list-disc ml-5">
                <li>ไปที่ <b>บันทึกรายการ</b> กรอก “รายได้”, “ค่าใช้จ่ายจ่าย”, “ค่าลดหย่อน”</li>
                <li>แนบไฟล์ใบเสร็จ (JPG/PNG/PDF) ได้หลายไฟล์ ระบบจะอัปโหลดไปยัง Google Drive โฟลเดอร์ <b>TaxOnline Receipts</b> อัตโนมัติ</li>
                <li>กด <b>บันทึกรายการ</b> เพื่อบันทึกลง Firestore</li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.4 คำนวณภาษี</p>
              <ul class="list-disc ml-5">
                <li>ไปที่ <b>คำนวณภาษี</b> กด <b>รีเฟรช</b> เพื่อโหลดประวัติล่าสุด</li>
                <li>เลือก <b>วิธีรายจ่ายรวม</b>: “ตามจริง” หรือ “เหมาจ่าย” (ตั้งค่า % และเพดานได้)</li>
                <li>ติ๊ก <b>“ตัดรายการที่ซ้ำ”</b> เพื่อลดรายการที่ลงซ้ำกัน (พิจารณาจากวันที่/ตัวเลข)</li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.5 ส่งออก & จัดเก็บ</p>
              <ul class="list-disc ml-5">
                <li>กด <b>ดาวน์โหลด CSV</b> เพื่อส่งออกประวัติละเอียด</li>
                <li>กด <b>ดาวน์โหลดสรุป PDF</b> เพื่อเก็บรายงานสรุปแบบหน้าเดียว/หลายหน้า</li>
                <li>กด <b>เปิดโฟลเดอร์ Drive</b> เพื่อเข้าไปดูไฟล์ใบเสร็จใน Google Drive</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">4) การคิดภาษี (คร่าว ๆ)</h4>
          <p>ระบบคำนวณ <b>ภาษีโดยประมาณ</b> จาก “รายได้ − ค่าใช้จ่าย − ลดหย่อน” แล้วนำไปเข้าชั้นภาษีแบบขั้นบันได</p>
          <p class="text-sm text-gray-600 mt-1">*ผลลัพธ์เป็นการประเมินเบื้องต้น ผู้ใช้ควรตรวจสอบกับที่ปรึกษาภาษีหรือกรมสรรพากรอีกครั้ง</p>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">5) คำถามที่พบบ่อย (FAQ)</h4>

          <details class="mb-2 p-3 bg-gray-50 rounded-lg">
            <summary class="cursor-pointer font-medium">กดเชื่อมต่อ Google Drive แล้วไม่ขึ้นว่าเชื่อมต่อ</summary>
            <div class="mt-2 text-sm">
              ตรวจว่าอินเทอร์เน็ตปกติ และเบราเซอร์ไม่บล็อกป๊อปอัป ลองกดเชื่อมต่อใหม่ หรือรีเฟรชหน้าเว็บ
            </div>
          </details>

          <details class="mb-2 p-3 bg-gray-50 rounded-lg">
            <summary class="cursor-pointer font-medium">ไฟล์ PDF ที่โหลดตัวหนังสือเพี้ยน/หน้าเปล่า</summary>
            <div class="mt-2 text-sm">
              (ปุ่มสรุป PDF หน้านี้ ใช้แบบ “ตัวอักษรจริง” แล้ว)
            </div>
          </details>

          <details class="mb-2 p-3 bg-gray-50 rounded-lg">
            <summary class="cursor-pointer font-medium">ดูไฟล์ใบเสร็จที่อัปโหลดไปแล้วตรงไหน</summary>
            <div class="mt-2 text-sm">
              ที่หน้า “คำนวณภาษี” จะมีคอลัมน์ “ไฟล์” พร้อมลิงก์ไปยังไฟล์บน Google Drive หรือกดปุ่ม “เปิดโฟลเดอร์ Drive”
            </div>
          </details>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">6) เคล็ดลับ & ความปลอดภัย</h4>
          <ul class="list-disc ml-5 space-y-1">
            <li>ตั้งชื่อไฟล์ใบเสร็จให้สื่อความหมาย เช่น <code>2025-03-10_ขนส่ง_kerry_350บาท.pdf</code></li>
            <li>ลงชื่อเข้าใช้เฉพาะอุปกรณ์ที่เชื่อถือ และกด “ออกจากระบบ” เมื่อใช้งานเสร็จ</li>
            <li>สำรอง CSV/PDF เป็นระยะ ๆ เผื่อกรณีฉุกเฉิน</li>
          </ul>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">7) ติดต่อผู้ดูแลระบบ</h4>
          <p>อีเมล: <a href="mailto:support@example.com" class="text-blue-600 hover:underline">support@example.com</a> (แก้เป็นของคุณ)</p>
        </section>

      </div>
    </div>
  </section>

  <!-- Diagnostics -->
  <section id="diagWrap" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
      <h3 class="text-lg font-semibold mb-2">Diagnostics</h3>
      <pre id="diag" class="text-xs whitespace-pre-wrap"></pre>
    </div>
  </section>

</div>

<footer class="bg-white p-4 text-center text-sm text-gray-500">
  &copy; 2025 ระบบเว็บไซต์คำนวณภาษีสำหรับพ่อค้า แม่ค้าออนไลน์
</footer>

<!-- ========== Fail-safe Splash: กันหน้า “ค้างกำลังโหลด” ========== -->
<script>
(function(){
  function hideSplash(){
    var s=document.getElementById('splash'); if(!s) return;
    s.style.opacity='0'; setTimeout(function(){ try{ s.style.display='none'; }catch(e){} },800);
  }
  window.__taxonlineSplashTimer=setTimeout(hideSplash,5000);
  window.addEventListener('load', function(){ setTimeout(hideSplash,1200); });
  window.addEventListener('error', function(evt){ console.error('[GlobalError]', evt.error||evt.message||evt); hideSplash(); });
  window.addEventListener('unhandledrejection', function(evt){ console.error('[UnhandledRejection]', evt.reason); hideSplash(); });
  window.__hideSplashNow = hideSplash;
})();
</script>

<script>
/* ========= UTIL ========= */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function waitForFirebase(maxMs=8000){
  const start = Date.now();
  while (typeof window.firebase === 'undefined'){
    if (Date.now() - start > maxMs) throw new Error('Firebase SDK ไม่ถูกโหลดภายในเวลา '+maxMs+'ms');
    await sleep(100);
  }
}
function showDiag(lines){
  const show = location.hash.includes('debug') || /[?&]debug=1/.test(location.search);
  if (!show) return;
  const wrap = document.getElementById('diagWrap');
  const pre = document.getElementById('diag');
  if (wrap && pre){
    wrap.classList.remove('hidden');
    pre.textContent = (Array.isArray(lines)?lines:[lines]).join('\n');
  }
}

/* ========= GLOBALS ========= */
let db, auth;

/* ========= Google Drive OAuth ========= */
const GOOGLE_OAUTH_CLIENT_ID = "959276043439-rpc16dfdslna3ndjijicg0gehu8klp93.apps.googleusercontent.com";
const DRIVE_SCOPES = "https://www.googleapis.com/auth/drive.file";
let driveTokenClient = null;
let driveAccessToken = null;
let driveTokenExpiry = 0;

function setDriveStatus(msg, ok=false){
  const el = document.getElementById('driveStatus');
  if (!el) return;
  el.textContent = msg;
  el.className = ok ? "bg-green-100 text-green-800 px-3 py-2 rounded shadow text-sm"
                    : "bg-white text-gray-700 px-3 py-2 rounded shadow text-sm";
}

async function connectDrive(){
  if (!window.google || !google.accounts || !google.accounts.oauth2) {
    alert('ยังโหลด Google OAuth ไม่เสร็จ ลองใหม่อีกครั้ง'); return;
  }
  if (!driveTokenClient) {
    driveTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_OAUTH_CLIENT_ID,
      scope: DRIVE_SCOPES,
      callback: (resp) => {
        if (resp && resp.access_token) {
          driveAccessToken = resp.access_token;
          driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
          setDriveStatus('เชื่อมต่อ Google Drive แล้ว', true);
        } else {
          setDriveStatus('เชื่อมต่อไม่สำเร็จ');
        }
      }
    });
  }
  driveTokenClient.requestAccessToken({ prompt: 'consent' });
}

async function ensureDriveToken(){
  if (driveAccessToken && Date.now() < driveTokenExpiry - 5000) return driveAccessToken;
  if (!driveTokenClient) {
    driveTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_OAUTH_CLIENT_ID,
      scope: DRIVE_SCOPES,
      callback: (resp) => {
        if (resp && resp.access_token) {
          driveAccessToken = resp.access_token;
          driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
          setDriveStatus('เชื่อมต่อ Google Drive แล้ว', true);
        }
      }
    });
  }
  return new Promise((resolve, reject) => {
    driveTokenClient.callback = (resp) => {
      if (resp && resp.access_token) {
        driveAccessToken = resp.access_token;
        driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
        setDriveStatus('เชื่อมต่อ Google Drive แล้ว', true);
        resolve(driveAccessToken);
      } else {
        setDriveStatus('เชื่อมต่อไม่สำเร็จ');
        reject(new Error('no access token'));
      }
    };
    driveTokenClient.requestAccessToken({ prompt: '' });
  });
}

// โฟลเดอร์ใบเสร็จ
async function getOrCreateDriveFolder(){
  const cacheKey = 'taxonline_drive_folder';
  const cached = localStorage.getItem(cacheKey);
  if (cached) return JSON.parse(cached);

  await ensureDriveToken();

  const searchRes = await fetch(
    'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent("name='TaxOnline Receipts' and mimeType='application/vnd.google-apps.folder' and trashed=false") + '&fields=files(id,webViewLink)',
    { headers: { 'Authorization': 'Bearer ' + driveAccessToken } }
  );
  if (searchRes.ok) {
    const j = await searchRes.json();
    if (j.files && j.files.length > 0) {
      const found = { id: j.files[0].id, webViewLink: j.files[0].webViewLink };
      localStorage.setItem(cacheKey, JSON.stringify(found));
      return found;
    }
  }

  const createRes = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,webViewLink', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + driveAccessToken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name: 'TaxOnline Receipts', mimeType: 'application/vnd.google-apps.folder' })
  });
  if (!createRes.ok) {
    const t = await createRes.text();
    throw new Error('สร้างโฟลเดอร์ใน Drive ไม่สำเร็จ: ' + t);
  }
  const data = await createRes.json();
  const out = { id: data.id, webViewLink: data.webViewLink };
  localStorage.setItem(cacheKey, JSON.stringify(out));
  return out;
}

// อัปโหลดไฟล์ไป Drive
async function uploadFilesToDrive(files, parentInfo){
  await ensureDriveToken();
  const results = [];
  const parentId = parentInfo?.id;

  for (const file of Array.from(files || [])) {
    const metadata = {
      name: file.name,
      mimeType: file.type || 'application/octet-stream',
      parents: parentId ? [parentId] : undefined
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    const url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink';
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + driveAccessToken },
      body: form
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error('อัปโหลดไป Drive ล้มเหลว: ' + t);
    }
    const json = await res.json();
    results.push({
      name: file.name,
      size: file.size || null,
      mimeType: file.type || null,
      driveFileId: json.id,
      webViewLink: json.webViewLink
    });
  }
  return results;
}

/* ========= UI helpers ========= */
const sections = {
  welcome: document.getElementById('welcomeSection'),
  auth: document.getElementById('authSection'),
  profile: document.getElementById('profileSection'),
  calculator: document.getElementById('calculatorSection'),
  history: document.getElementById('historySection'),
  guide: document.getElementById('guideSection'),
  diag: document.getElementById('diagWrap')
};
const userGreeting = document.getElementById('userGreeting');
const loginNav = document.getElementById('loginNav');
const logoutBtn = document.getElementById('logoutBtn');
const historyBody = document.getElementById('historyBody');
const historyMsg = document.getElementById('historyMsg');
const profileMsg = document.getElementById('profileMsg');
const saveMsg = document.getElementById('saveMsg');

function showOnly(sectionKey){
  Object.keys(sections).forEach(k=>{
    if (!sections[k]) return;
    sections[k].classList.toggle('hidden', k!==sectionKey);
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.querySelectorAll('[data-nav]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.getAttribute('data-nav');
    if (target==='calculator' || target==='history' || target==='profile') {
      if (!auth || !auth.currentUser) { alert('กรุณาเข้าสู่ระบบก่อน'); showOnly('auth'); return; }
    }
    if (target==='history') loadHistory();
    if (target==='profile') loadProfile();
    showOnly(target);
  });
});

document.getElementById('driveConnectBtn').addEventListener('click', connectDrive);

// Clock
function updateDateTime(){
  const now = new Date();
  const timeStr = now.toLocaleTimeString('th-TH');
  const dateStr = now.toLocaleDateString('th-TH', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const el = document.getElementById('datetime'); if (el) el.innerText = `${dateStr} ${timeStr}`;
}
setInterval(updateDateTime, 1000); updateDateTime();

window.addEventListener('load', ()=>{
  setTimeout(()=>{ const s=document.getElementById('splash'); s.style.opacity='0'; setTimeout(()=>s.style.display='none',800); },1200);
  showOnly('welcome');
});

// Auth tabs
const loginTab = document.getElementById('loginTab');
const signupTab = document.getElementById('signupTab');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const authMessage = document.getElementById('authMessage');
loginTab.addEventListener('click', ()=>{ loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); authMessage.textContent=''; });
signupTab.addEventListener('click', ()=>{ signupForm.classList.remove('hidden'); loginForm.classList.add('hidden'); authMessage.textContent=''; });
loginTab.click();

/* ========= Profile ========= */
const profileForm = document.getElementById('profileForm');
const profileFirstName = document.getElementById('profileFirstName');
const profileLastName = document.getElementById('profileLastName');
const profileEmail = document.getElementById('profileEmail');
const profilePhone = document.getElementById('profilePhone');
const profileAddress = document.getElementById('profileAddress');
document.getElementById('reloadProfile').addEventListener('click', loadProfile);

async function loadProfile(){
  profileMsg.textContent='';
  if (!auth || !auth.currentUser) { profileMsg.textContent='กรุณาเข้าสู่ระบบ'; profileMsg.className='text-red-600 text-sm mt-2'; return; }
  try {
    const snap = await db.collection('users').doc(auth.currentUser.uid).get();
    if (snap.exists) {
      const d = snap.data();
      profileFirstName.value = d.firstName || '';
      profileLastName.value  = d.lastName  || '';
      profileEmail.value     = d.email     || auth.currentUser.email || '';
      profilePhone.value     = d.phone     || '';
      profileAddress.value   = d.address   || '';
      profileMsg.textContent='โหลดข้อมูลสำเร็จ'; profileMsg.className='text-green-600 text-sm mt-2';
    } else {
      const u = auth.currentUser;
      profileFirstName.value = u.displayName ? u.displayName.split(' ')[0] : '';
      profileLastName.value  = u.displayName ? u.displayName.split(' ').slice(1).join(' ') : '';
      profileEmail.value     = u.email || '';
      profileMsg.textContent='ยังไม่มีข้อมูลโปรไฟล์ กรอกแล้วกดบันทึกได้เลย'; profileMsg.className='text-yellow-600 text-sm mt-2';
    }
  } catch(e){ profileMsg.textContent=e.message; profileMsg.className='text-red-600 text-sm mt-2'; }
}

profileForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!auth || !auth.currentUser) { alert('กรุณาเข้าสู่ระบบ'); showOnly('auth'); return; }
  try {
    await db.collection('users').doc(auth.currentUser.uid).set({
      uid:auth.currentUser.uid,
      firstName: profileFirstName.value.trim(),
      lastName:  profileLastName.value.trim(),
      email:     profileEmail.value.trim() || auth.currentUser.email,
      phone:     profilePhone.value.trim(),
      address:   profileAddress.value.trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    await auth.currentUser.updateProfile({ displayName: `${profileFirstName.value.trim()} ${profileLastName.value.trim()}`.trim() });
    userGreeting.textContent = `สวัสดี, ${auth.currentUser.displayName || auth.currentUser.email}`;
    profileMsg.textContent='บันทึกโปรไฟล์สำเร็จ'; profileMsg.className='text-green-600 text-sm mt-2';
  } catch(e){ profileMsg.textContent=e.message; profileMsg.className='text-red-600 text-sm mt-2'; }
});

/* ========= File input preview ========= */
const ALLOW_TYPES = ['image/jpeg','image/png','application/pdf'];
const MAX_FILES = 10;
const MAX_FILE_SIZE_MB = 8;

document.getElementById('receiptUpload').addEventListener('change', function(){
  const files = Array.from(this.files || []);
  if (files.length > MAX_FILES) { alert(`เลือกได้ไม่เกิน ${MAX_FILES} ไฟล์ต่อครั้ง`); this.value=''; return; }
  for (const f of files) {
    if (!ALLOW_TYPES.includes(f.type)) { alert(`ไฟล์ ${f.name} ไม่รองรับ (JPG/PNG/PDF เท่านั้น)`); this.value=''; return; }
    if (f.size > MAX_FILE_SIZE_MB*1024*1024) { alert(`ไฟล์ ${f.name} > ${MAX_FILE_SIZE_MB}MB`); this.value=''; return; }
  }
  const info = document.getElementById('fileInfo');
  const preview = document.getElementById('previewArea');
  if (info) info.textContent = `คุณเลือก ${files.length} ไฟล์`;
 
