<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TaxOnline - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå </title>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<!-- Chart.js (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF + autoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<!-- html2canvas (‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏à‡∏≠‡∏£‡πå DOM ‚Üí ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Google Identity Services (OAuth 2.0 for Drive) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body{
    background:linear-gradient(-45deg,#e0c3fc,#8ec5fc,#fbc2eb,#a1c4fd);
    background-size:400% 400%;
    animation:gradientBG 15s ease infinite;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }
  @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .fade-in{animation:fadeIn .7s ease-in}
  @keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
  #splash{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:1;transition:opacity .8s ease}
  .splash-spinner{width:60px;height:60px;border:8px solid transparent;border-top-color:#ec4899;border-radius:50%;animation:spin 1.4s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .nav-link{display:inline-block;margin:.25rem .4rem}
  #diag{font-family:ui-monospace,Menlo,Consolas,monospace}

  /* ‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏Ñ‡∏•‡∏ô‡πÑ‡∏õ‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏à‡∏≠‡∏£‡πå (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ô‡∏≠‡∏Å‡∏à‡∏≠) */
  #print-clone-host{
    position: fixed; left: -10000px; top: 0;
    width: 1240px; /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á ~1240px ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πÄ‡∏Å‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏°‡∏á‡πà‡∏≤‡∏¢ */
    background: #fff;
  }

  /* ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á/‡πÄ‡∏á‡∏≤/‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏ö‡∏ô clone (‡∏•‡∏î‡πÄ‡∏ö‡∏•‡∏≠) */
  .print-sanitized, .print-sanitized *{
    animation: none !important;
    transition: none !important;
    filter: none !important;
    backdrop-filter: none !important;
    box-shadow: none !important;
  }

  /* ‡∏•‡∏î‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏ß‡∏ô‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
  @media print {
    body { animation: none !important; }
    #splash, header, footer, .fixed { display: none !important; }
  }
</style>
</head>
<body class="font-sans">

<!-- Splash -->
<div id="splash">
  <div class="splash-spinner"></div>
  <h2 class="text-xl font-semibold text-pink-600 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</h2>
</div>

<!-- Header -->
<header class="bg-white shadow p-4 fixed w-full z-30 top-0">
  <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center">
    <div class="flex items-center gap-3 mb-2 sm:mb-0">
      <h1 class="text-2xl font-bold text-pink-600">TaxOnline Vers 0.2 </h1>
      <span id="userGreeting" class="text-sm text-gray-600 hidden">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‚Ä¶</span>
    </div>
    <nav class="text-center sm:text-right">
      <button class="nav-link text-pink-600 hover:underline font-semibold" data-nav="welcome">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="calculator">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="history">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
      <button class="nav-link text-gray-700 hover:underline" data-nav="guide">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
      <button id="loginNav" class="nav-link text-blue-600 hover:underline font-semibold" data-nav="auth">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button id="logoutBtn" class="nav-link text-red-600 hover:underline hidden">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </nav>
  </div>
</header>

<!-- Time + Drive status -->
<div class="fixed top-20 sm:top-4 left-4 z-50 bg-white text-sm text-gray-700 px-3 py-1 rounded shadow">
  <span id="datetime">--:--</span>
</div>
<div class="fixed top-20 sm:top-4 right-4 z-50 flex gap-2">
  <button id="driveConnectBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm font-medium">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive</button>
  <span id="driveStatus" class="bg-white text-gray-700 px-3 py-2 rounded shadow text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
</div>

<div class="pt-28 pb-16">

  <!-- Welcome -->
  <section id="welcomeSection" class="fade-in text-center px-6">
    <h2 class="text-3xl sm:text-4xl font-bold text-pink-700 mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
    <p class="text-gray-700 text-base sm:text-lg max-w-2xl mx-auto">
      ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ <b>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</b>
    </p>
    <div class="mt-6 flex items-center justify-center gap-3 flex-wrap">
      <button class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="calculator">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full text-lg shadow transition" data-nav="auth" id="welcomeLoginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      <button class="bg-white hover:bg-gray-50 text-gray-700 px-6 py-3 rounded-full text-lg shadow transition border" data-nav="guide">‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</button>
    </div>
  </section>

  <!-- Auth -->
  <section id="authSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl">
      <h2 class="text-2xl font-bold text-center text-pink-600 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

      <div class="flex justify-center space-x-4 mb-6">
        <button id="loginTab" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button id="signupTab" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </div>

      <!-- Login -->
      <form id="loginForm" class="space-y-4 hidden">
        <input type="email" id="loginEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <input type="password" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>

      <!-- Signup -->
      <form id="signupForm" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
          <input type="text" id="signupFirstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
          <input type="text" id="signupLastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        </div>
        <input type="email" id="signupEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <input type="password" id="signupPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold" type="submit">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </form>

      <div class="mt-6 border-t pt-4">
        <button id="googleSignInBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google (Firebase Auth)
        </button>
      </div>

      <p id="authMessage" class="text-red-500 text-center mt-4 text-sm"></p>
    </div>
  </section>

  <!-- Profile -->
  <section id="profileSection" class="hidden fade-in px-4">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-2xl font-semibold text-pink-600 mb-4">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <form id="profileForm" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700">‡∏ä‡∏∑‡πà‡∏≠</label>
            <input id="profileFirstName" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
          <div>
            <label class="block text-sm text-gray-700">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="profileLastName" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="profileEmail" type="email" class="w-full p-2 border rounded-lg" disabled/>
          </div>
          <div>
            <label class="block text-sm text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
            <input id="profilePhone" type="text" class="w-full p-2 border rounded-lg"/>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
          <textarea id="profileAddress" rows="3" class="w-full p-2 border rounded-lg"></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
          <button type="button" id="reloadProfile" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <p id="profileMsg" class="text-sm mt-2"></p>
      </form>
    </div>
  </section>

  <!-- Calculator -->
  <section id="calculatorSection" class="hidden fade-in px-4">
    <div class="max-w-md mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
      <h3 class="text-xl sm:text-2xl font-semibold text-center text-blue-600 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô</h3>
      <form class="space-y-4" id="recordForm">
        <div>
          <label class="block text-sm font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="rec_income" class="w-full p-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="rec_expense" class="w-full p-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-800">‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="rec_deduction" value="60000" class="w-full p-2 border rounded-lg"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-800">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏≠‡∏±‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</label>
          <input type="file" id="receiptUpload" accept="image/*,.pdf" multiple
                 class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
          <p class="mt-1 text-xs text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, PDF (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</p>
          <div id="fileInfo" class="mt-2 text-sm text-gray-700"></div>
          <div id="previewArea" class="mt-2 grid grid-cols-3 gap-2"></div>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </form>
      <p id="saveMsg" class="text-sm mt-3"></p>
    </div>
  </section>

  <!-- History -->
  <section id="historySection" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-semibold text-pink-600">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
        <div class="flex gap-2">
          <button id="refreshHistory" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button id="downloadCsvBtn" class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
          <button id="downloadPdfBtn" class="px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ PDF</button>
          <button id="openDriveFolderBtn" class="px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Drive</button>
        </div>
      </div>

      <!-- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° + ‡∏ï‡∏±‡∏î‡∏ã‡πâ‡∏≥ -->
      <div id="methodPanel" class="mb-4 p-4 rounded-xl bg-white border text-sm grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <div class="font-medium text-gray-800 mb-1">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>
          <label class="inline-flex items-center gap-2 mr-4"><input type="radio" name="sumExpenseMethod" value="actual" checked> ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á</label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="sumExpenseMethod" value="lumpsum"> ‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢</label>

          <div id="sumLumpsumConfig" class="grid grid-cols-2 gap-3 mt-3 hidden">
            <div>
              <label class="block text-xs text-gray-500">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢ (%)</label>
              <input type="number" id="sumLumpsumPercent" value="50" class="w-full p-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-xs text-gray-500">‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó) <span class="text-gray-400">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></label>
              <input type="number" id="sumLumpsumCap" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100000" class="w-full p-2 border rounded-lg">
            </div>
          </div>
        </div>

        <div class="md:col-span-1">
          <label class="inline-flex items-center gap-2 mt-1">
            <input type="checkbox" id="dedupeToggle" checked>
            ‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥ (‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å)
          </label>
        </div>
      </div>

      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏° -->
      <div id="summaryPanel" class="mb-4 p-4 rounded-xl bg-gray-50 grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
        <div>
          <div class="text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
          <div id="sumIncome" class="text-xl font-semibold">‚Äî</div>
        </div>
        <div>
          <div class="text-gray-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</div>
          <div id="sumExpense" class="text-xl font-semibold">‚Äî</div>
        </div>
        <div>
          <div class="text-gray-500">‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°</div>
          <div id="sumDeduct" class="text-xl font-semibold">‚Äî</div>
        </div>
        <div>
          <div class="text-gray-500">‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</div>
          <div id="sumTax" class="text-2xl font-bold text-red-600">‚Äî</div>
        </div>
      </div>

      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left bg-gray-50">
              <th class="px-3 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="px-3 py-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
              <th class="px-3 py-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</th>
              <th class="px-3 py-2">‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô</th>
              <th class="px-3 py-2">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</th>
              <th class="px-3 py-2">‡πÑ‡∏ü‡∏•‡πå</th>
              <th class="px-3 py-2">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <p id="historyMsg" class="text-sm mt-3"></p>
    </div>
  </section>

  <!-- Guide -->
  <section id="guideSection" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between gap-3">
        <h3 class="text-2xl font-semibold text-pink-600">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö TaxOnline</h3>
        <button id="downloadGuidePdfBtn" class="px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-sm">
          ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ PDF
        </button>
      </div>

      <p class="mt-2 text-gray-600 text-sm">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: 2025</p>

      <div class="mt-6 space-y-8 text-gray-800 leading-relaxed">
        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">1) ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h4>
          <ul class="list-disc ml-5 space-y-1">
            <li><b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ç‡∏∂‡πâ‡∏ô Google Drive ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</li>
            <li><b>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</b> ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á/‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥</li>
            <li><b>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</b> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡∏ä‡∏∑‡πà‡∏≠-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà-‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå)</li>
            <li><b>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</b> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô CSV ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô PDF</li>
          </ul>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">2) ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
          <ol class="list-decimal ml-5 space-y-2">
            <li>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Chrome/Edge ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</li>
            <li>‡∏™‡∏°‡∏±‡∏Ñ‡∏£/‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏µ‡πÄ‡∏°‡∏•+‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ Google)</li>
            <li>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÇ‡∏î‡∏¢‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>‚Äú‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive‚Äù</b> ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô</li>
          </ol>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">3) ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h4>
          <div class="space-y-3">
            <div>
              <p class="font-medium">3.1 ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö/‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
              <ul class="list-disc ml-5">
                <li>‡∏´‡∏ô‡πâ‡∏≤ <b>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏ö ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‚Äù</li>
                <li>‡∏Å‡∏î <b>‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google‚Äù</b> ‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å</li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.2 ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</p>
              <ul class="list-disc ml-5">
                <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π <b>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</b> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà-‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</b></li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.3 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
              <ul class="list-disc ml-5">
                <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‚Äù, ‚Äú‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‚Äù, ‚Äú‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‚Äù</li>
                <li>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (JPG/PNG/PDF) ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå <b>TaxOnline Receipts</b> ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
                <li>‡∏Å‡∏î <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore</li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.4 ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</p>
              <ul class="list-disc ml-5">
                <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <b>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</b> ‡∏Å‡∏î <b>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</li>
                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</b>: ‚Äú‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢‚Äù (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ % ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡πÑ‡∏î‡πâ)</li>
                <li>‡∏ï‡∏¥‡πä‡∏Å <b>‚Äú‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‚Äù</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</li>
              </ul>
            </div>
            <div>
              <p class="font-medium">3.5 ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å & ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</p>
              <ul class="list-disc ml-5">
                <li>‡∏Å‡∏î <b>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</li>
                <li>‡∏Å‡∏î <b>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ PDF</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß/‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤</li>
                <li>‡∏Å‡∏î <b>‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Drive</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô Google Drive</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">4) ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏†‡∏≤‡∏©‡∏µ (‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ)</h4>
          <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì <b>‡∏†‡∏≤‡∏©‡∏µ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</b> ‡∏à‡∏≤‡∏Å ‚Äú‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‚àí ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‚àí ‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î</p>
          <p class="text-sm text-gray-600 mt-1">*‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏°‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        </section>

        <!-- FAQ -->
        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">5) ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢ (FAQ)</h4>

          <details class="mb-2 p-3 bg-gray-50 rounded-lg">
            <summary class="cursor-pointer font-medium">‡∏Å‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</summary>
            <div class="mt-2 text-sm">
              ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏£‡∏≤‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            </div>
          </details>

          <details class="mb-2 p-3 bg-gray-50 rounded-lg">
            <summary class="cursor-pointer font-medium">‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô/‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡πà‡∏≤</summary>
            <div class="mt-2 text-sm">
              ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏ö‡∏ö‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤ (html2canvas) ‡∏ã‡∏∂‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå/‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ú‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° <b>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ PDF</b> ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
            </div>
          </details>

          <details class="mb-2 p-3 bg-gray-50 rounded-lg">
            <summary class="cursor-pointer font-medium">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô</summary>
            <div class="mt-2 text-sm">
              ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‚Äù ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚Äú‡πÑ‡∏ü‡∏•‡πå‚Äù ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô Google Drive ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Drive‚Äù
            </div>
          </details>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">6) ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö & ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h4>
          <ul class="list-disc ml-5 space-y-1">
            <li>‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô <code>2025-03-10_‡∏Ç‡∏ô‡∏™‡πà‡∏á_kerry_350‡∏ö‡∏≤‡∏ó.pdf</code></li>
            <li>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÅ‡∏•‡∏∞‡∏Å‡∏î ‚Äú‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‚Äù ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</li>
            <li>‡∏™‡∏≥‡∏£‡∏≠‡∏á CSV/PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ ‡πÜ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</li>
          </ul>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-blue-600 mb-2">7) ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h4>
          <p>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: <a href="mailto:support@example.com" class="text-blue-600 hover:underline">support@example.com</a> (‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</p>
        </section>

      </div>
    </div>
  </section>

  <!-- Diagnostics -->
  <section id="diagWrap" class="hidden fade-in px-4">
    <div class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
      <h3 class="text-lg font-semibold mb-2">Diagnostics</h3>
      <pre id="diag" class="text-xs whitespace-pre-wrap"></pre>
    </div>
  </section>

</div>

<footer class="bg-white p-4 text-center text-sm text-gray-500">
  &copy; 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
</footer>

<script>
/* ========= UTIL ========= */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function waitForFirebase(maxMs=8000){
  const start = Date.now();
  while (typeof window.firebase === 'undefined'){
    if (Date.now() - start > maxMs) throw new Error('Firebase SDK ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ '+maxMs+'ms');
    await sleep(100);
  }
}
function showDiag(lines){
  const show = location.hash.includes('debug') || /[?&]debug=1/.test(location.search);
  if (!show) return;
  const wrap = document.getElementById('diagWrap');
  const pre = document.getElementById('diag');
  if (wrap && pre){
    wrap.classList.remove('hidden');
    pre.textContent = (Array.isArray(lines)?lines:[lines]).join('\n');
  }
}

/* ========= GLOBALS ========= */
let db, auth;

/* ========= Google Drive OAuth ========= */
const GOOGLE_OAUTH_CLIENT_ID = "959276043439-rpc16dfdslna3ndjijicg0gehu8klp93.apps.googleusercontent.com";
const DRIVE_SCOPES = "https://www.googleapis.com/auth/drive.file";
let driveTokenClient = null;
let driveAccessToken = null;
let driveTokenExpiry = 0;

function setDriveStatus(msg, ok=false){
  const el = document.getElementById('driveStatus');
  if (!el) return;
  el.textContent = msg;
  el.className = ok ? "bg-green-100 text-green-800 px-3 py-2 rounded shadow text-sm"
                    : "bg-white text-gray-700 px-3 py-2 rounded shadow text-sm";
}

async function connectDrive(){
  if (!window.google || !google.accounts || !google.accounts.oauth2) {
    alert('‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Google OAuth ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); return;
  }
  if (!driveTokenClient) {
    driveTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_OAUTH_CLIENT_ID,
      scope: DRIVE_SCOPES,
      callback: (resp) => {
        if (resp && resp.access_token) {
          driveAccessToken = resp.access_token;
          driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
          setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÅ‡∏•‡πâ‡∏ß', true);
        } else {
          setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      }
    });
  }
  driveTokenClient.requestAccessToken({ prompt: 'consent' });
}

async function ensureDriveToken(){
  if (driveAccessToken && Date.now() < driveTokenExpiry - 5000) return driveAccessToken;
  if (!driveTokenClient) {
    driveTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_OAUTH_CLIENT_ID,
      scope: DRIVE_SCOPES,
      callback: (resp) => {
        if (resp && resp.access_token) {
          driveAccessToken = resp.access_token;
          driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
          setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÅ‡∏•‡πâ‡∏ß', true);
        }
      }
    });
  }
  return new Promise((resolve, reject) => {
    driveTokenClient.callback = (resp) => {
      if (resp && resp.access_token) {
        driveAccessToken = resp.access_token;
        driveTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
        setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡πÅ‡∏•‡πâ‡∏ß', true);
        resolve(driveAccessToken);
      } else {
        setDriveStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        reject(new Error('no access token'));
      }
    };
    driveTokenClient.requestAccessToken({ prompt: '' });
  });
}

// ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
async function getOrCreateDriveFolder(){
  const cacheKey = 'taxonline_drive_folder';
  const cached = localStorage.getItem(cacheKey);
  if (cached) return JSON.parse(cached);

  await ensureDriveToken();

  const searchRes = await fetch(
    'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent("name='TaxOnline Receipts' and mimeType='application/vnd.google-apps.folder' and trashed=false") + '&fields=files(id,webViewLink)',
    { headers: { 'Authorization': 'Bearer ' + driveAccessToken } }
  );
  if (searchRes.ok) {
    const j = await searchRes.json();
    if (j.files && j.files.length > 0) {
      const found = { id: j.files[0].id, webViewLink: j.files[0].webViewLink };
      localStorage.setItem(cacheKey, JSON.stringify(found));
      return found;
    }
  }

  const createRes = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,webViewLink', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + driveAccessToken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name: 'TaxOnline Receipts', mimeType: 'application/vnd.google-apps.folder' })
  });
  if (!createRes.ok) {
    const t = await createRes.text();
    throw new Error('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Drive ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + t);
  }
  const data = await createRes.json();
  const out = { id: data.id, webViewLink: data.webViewLink };
  localStorage.setItem(cacheKey, JSON.stringify(out));
  return out;
}

// ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Drive
async function uploadFilesToDrive(files, parentInfo){
  await ensureDriveToken();
  const results = [];
  const parentId = parentInfo?.id;

  for (const file of Array.from(files || [])) {
    const metadata = {
      name: file.name,
      mimeType: file.type || 'application/octet-stream',
      parents: parentId ? [parentId] : undefined
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    const url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink';
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + driveAccessToken },
      body: form
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Drive ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + t);
    }
    const json = await res.json();
    results.push({
      name: file.name,
      size: file.size || null,
      mimeType: file.type || null,
      driveFileId: json.id,
      webViewLink: json.webViewLink
    });
  }
  return results;
}

/* ========= UI helpers ========= */
const sections = {
  welcome: document.getElementById('welcomeSection'),
  auth: document.getElementById('authSection'),
  profile: document.getElementById('profileSection'),
  calculator: document.getElementById('calculatorSection'),
  history: document.getElementById('historySection'),
  guide: document.getElementById('guideSection'),
  diag: document.getElementById('diagWrap')
};
const userGreeting = document.getElementById('userGreeting');
const loginNav = document.getElementById('loginNav');
const logoutBtn = document.getElementById('logoutBtn');
const historyBody = document.getElementById('historyBody');
const historyMsg = document.getElementById('historyMsg');
const profileMsg = document.getElementById('profileMsg');
const saveMsg = document.getElementById('saveMsg');

function showOnly(sectionKey){
  Object.keys(sections).forEach(k=>{
    if (!sections[k]) return;
    sections[k].classList.toggle('hidden', k!==sectionKey);
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.querySelectorAll('[data-nav]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.getAttribute('data-nav');
    if (target==='calculator' || target==='history' || target==='profile') {
      if (!auth || !auth.currentUser) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); showOnly('auth'); return; }
    }
    if (target==='history') loadHistory();
    if (target==='profile') loadProfile();
    showOnly(target);
  });
});

document.getElementById('driveConnectBtn').addEventListener('click', connectDrive);

// Clock
function updateDateTime(){
  const now = new Date();
  const timeStr = now.toLocaleTimeString('th-TH');
  const dateStr = now.toLocaleDateString('th-TH', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const el = document.getElementById('datetime'); if (el) el.innerText = `${dateStr} ${timeStr}`;
}
setInterval(updateDateTime, 1000); updateDateTime();

window.addEventListener('load', ()=>{
  setTimeout(()=>{ const s=document.getElementById('splash'); s.style.opacity='0'; setTimeout(()=>s.style.display='none',800); },1200);
  showOnly('welcome');
});

// Auth tabs
const loginTab = document.getElementById('loginTab');
const signupTab = document.getElementById('signupTab');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const authMessage = document.getElementById('authMessage');
loginTab.addEventListener('click', ()=>{ loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); authMessage.textContent=''; });
signupTab.addEventListener('click', ()=>{ signupForm.classList.remove('hidden'); loginForm.classList.add('hidden'); authMessage.textContent=''; });
loginTab.click();

/* ========= Profile ========= */
const profileForm = document.getElementById('profileForm');
const profileFirstName = document.getElementById('profileFirstName');
const profileLastName = document.getElementById('profileLastName');
const profileEmail = document.getElementById('profileEmail');
const profilePhone = document.getElementById('profilePhone');
const profileAddress = document.getElementById('profileAddress');
document.getElementById('reloadProfile').addEventListener('click', loadProfile);

async function loadProfile(){
  profileMsg.textContent='';
  if (!auth || !auth.currentUser) { profileMsg.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; profileMsg.className='text-red-600 text-sm mt-2'; return; }
  try {
    const snap = await db.collection('users').doc(auth.currentUser.uid).get();
    if (snap.exists) {
      const d = snap.data();
      profileFirstName.value = d.firstName || '';
      profileLastName.value  = d.lastName  || '';
      profileEmail.value     = d.email     || auth.currentUser.email || '';
      profilePhone.value     = d.phone     || '';
      profileAddress.value   = d.address   || '';
      profileMsg.textContent='‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; profileMsg.className='text-green-600 text-sm mt-2';
    } else {
      const u = auth.currentUser;
      profileFirstName.value = u.displayName ? u.displayName.split(' ')[0] : '';
      profileLastName.value  = u.displayName ? u.displayName.split(' ').slice(1).join(' ') : '';
      profileEmail.value     = u.email || '';
      profileMsg.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'; profileMsg.className='text-yellow-600 text-sm mt-2';
    }
  } catch(e){ profileMsg.textContent=e.message; profileMsg.className='text-red-600 text-sm mt-2'; }
}

profileForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!auth || !auth.currentUser) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); showOnly('auth'); return; }
  try {
    await db.collection('users').doc(auth.currentUser.uid).set({
      uid:auth.currentUser.uid,
      firstName: profileFirstName.value.trim(),
      lastName:  profileLastName.value.trim(),
      email:     profileEmail.value.trim() || auth.currentUser.email,
      phone:     profilePhone.value.trim(),
      address:   profileAddress.value.trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    await auth.currentUser.updateProfile({ displayName: `${profileFirstName.value.trim()} ${profileLastName.value.trim()}`.trim() });
    userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${auth.currentUser.displayName || auth.currentUser.email}`;
    profileMsg.textContent='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; profileMsg.className='text-green-600 text-sm mt-2';
  } catch(e){ profileMsg.textContent=e.message; profileMsg.className='text-red-600 text-sm mt-2'; }
});

/* ========= File input preview ========= */
const ALLOW_TYPES = ['image/jpeg','image/png','application/pdf'];
const MAX_FILES = 10;
const MAX_FILE_SIZE_MB = 8;

document.getElementById('receiptUpload').addEventListener('change', function(){
  const files = Array.from(this.files || []);
  if (files.length > MAX_FILES) { alert(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${MAX_FILES} ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á`); this.value=''; return; }
  for (const f of files) {
    if (!ALLOW_TYPES.includes(f.type)) { alert(`‡πÑ‡∏ü‡∏•‡πå ${f.name} ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (JPG/PNG/PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)`); this.value=''; return; }
    if (f.size > MAX_FILE_SIZE_MB*1024*1024) { alert(`‡πÑ‡∏ü‡∏•‡πå ${f.name} > ${MAX_FILE_SIZE_MB}MB`); this.value=''; return; }
  }
  const info = document.getElementById('fileInfo');
  const preview = document.getElementById('previewArea');
  if (info) info.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${files.length} ‡πÑ‡∏ü‡∏•‡πå`;
  if (preview) {
    preview.innerHTML = '';
    files.forEach(f=>{
      if (f.type.startsWith('image/')) {
        const fr = new FileReader();
        fr.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result; img.className='w-full h-24 object-cover rounded shadow';
          preview.appendChild(img);
        };
        fr.readAsDataURL(f);
      } else {
        const p = document.createElement('p'); p.textContent = `üìÑ ${f.name}`; p.className='text-xs text-gray-700';
        preview.appendChild(p);
      }
    });
  }
});

/* ========= Tax utils ========= */
function thaiProgressiveTax(net){
  if (net <= 0) return 0;
  const brackets = [
    { limit: 150000, rate: 0.00 },
    { limit: 300000, rate: 0.05 },
    { limit: 500000, rate: 0.10 },
    { limit: 750000, rate: 0.15 },
    { limit: 1000000, rate: 0.20 },
    { limit: 2000000, rate: 0.25 },
    { limit: 5000000, rate: 0.30 },
    { limit: Infinity, rate: 0.35 }
  ];
  let tax = 0; let prev = 0;
  for (const b of brackets){
    const upper = Math.min(net, b.limit);
    if (upper > prev) tax += (upper - prev) * b.rate;
    if (net <= b.limit) break; prev = b.limit;
  }
  return tax;
}

function getExpenseConfigFromUI(){
  const method = (document.querySelector('input[name="sumExpenseMethod"]:checked')||{}).value || 'actual';
  const percent = Number(document.getElementById('sumLumpsumPercent')?.value || 50);
  const cap = Number(document.getElementById('sumLumpsumCap')?.value || NaN);
  return { method, percent, cap };
}

function computeExpenseUsed(row, cfg){
  const income = Number(row.income||0);
  if (!cfg || cfg.method === 'actual') return Number(row.expense||0);
  const p = Math.max(0, Math.min(100, Number(cfg.percent||50)));
  const cap = Number(cfg.cap);
  const byPercent = income * (p/100);
  return (isNaN(cap) || cap<=0) ? byPercent : Math.min(byPercent, cap);
}

/* ========= ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ========= */
const recordForm = document.getElementById('recordForm');
recordForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const income = Number(document.getElementById('rec_income').value);
  const expense = Number(document.getElementById('rec_expense').value);
  const deduction = Number(document.getElementById('rec_deduction').value);
  const fileInput = document.getElementById('receiptUpload');
  const files = fileInput?.files || [];

  if (Number.isNaN(income)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç'); return; }
  if (Number.isNaN(expense)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç'); return; }
  if (Number.isNaN(deduction)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç'); return; }

  if (!auth || !auth.currentUser){ saveMsg.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'; saveMsg.className='text-yellow-600 text-sm mt-3'; return; }

  try {
    const payload = {
      income: income||0,
      expense: expense||0,
      deduction: deduction||0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      receipts: []
    };

    const docRef = await db.collection('users').doc(auth.currentUser.uid).collection('calculations').add(payload);

    let uploaded = [];
    if (files.length > 0) {
      await ensureDriveToken();
      const folderInfo = await getOrCreateDriveFolder();
      uploaded = await uploadFilesToDrive(files, folderInfo);
    }

    if (uploaded.length) await docRef.update({ receipts: uploaded });

    recordForm.reset();
    document.getElementById('fileInfo').textContent='';
    document.getElementById('previewArea').innerHTML='';

    saveMsg.textContent = uploaded.length ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive (${uploaded.length} ‡πÑ‡∏ü‡∏•‡πå)` : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    saveMsg.className = 'text-green-600 text-sm mt-3';
  } catch(e){
    console.error(e);
    saveMsg.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message||''}`;
    saveMsg.className = 'text-red-600 text-sm mt-3';
  }
});

/* ========= History ========= */
let lastRows = [];

async function fetchAllCalculations() {
  if (!auth || !auth.currentUser) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
  const snap = await db.collection('users').doc(auth.currentUser.uid)
    .collection('calculations').orderBy('createdAt','desc').get();
  return snap.docs.map(d => {
    const v = d.data();
    const dt = v.createdAt && v.createdAt.toDate ? v.createdAt.toDate() : null;
    return {
      id: d.id,
      date: dt ? dt.toLocaleString('th-TH') : '',
      income: v.income || 0,
      expense: v.expense || 0,
      deduction: v.deduction || 0,
      receipts: Array.isArray(v.receipts) ? v.receipts : []
    };
  });
}

// ‡∏ï‡∏±‡∏î‡πÅ‡∏ñ‡∏ß‡∏ã‡πâ‡∏≥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°/‡πÅ‡∏™‡∏î‡∏á/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å) ‚Äî key: date|income|expense|deduction
function maybeDedupe(rows){
  const chk = document.getElementById('dedupeToggle');
  if (!chk || !chk.checked) return rows;
  const seen = new Set();
  const out = [];
  for (const r of rows){
    const key = [r.date, Number(r.income||0), Number(r.expense||0), Number(r.deduction||0)].join('|');
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(r);
  }
  return out;
}

function renderSummary(rows){
  const cfg = getExpenseConfigFromUI();
  const rowsUse = maybeDedupe(rows);
  let sumIncome=0, sumExpense=0, sumDeduct=0, sumNet=0;
  rowsUse.forEach(r=>{
    const inc = Number(r.income||0);
    const expUsed = computeExpenseUsed(r, cfg);
    const ded = Number(r.deduction||0);
    sumIncome += inc; sumExpense += expUsed; sumDeduct += ded; sumNet += Math.max(0, inc - expUsed - ded);
  });
  const tax = thaiProgressiveTax(sumNet);
  document.getElementById('sumIncome').textContent = sumIncome.toLocaleString('th-TH');
  document.getElementById('sumExpense').textContent = sumExpense.toLocaleString('th-TH');
  document.getElementById('sumDeduct').textContent = sumDeduct.toLocaleString('th-TH');
  document.getElementById('sumTax').textContent = tax.toLocaleString('th-TH');
}

async function loadHistory(){
  historyMsg.textContent=''; historyBody.innerHTML='';
  if (!auth || !auth.currentUser) { historyMsg.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; historyMsg.className='text-red-600'; return; }

  try {
    const rows = await fetchAllCalculations();
    lastRows = rows;
    const cfg = getExpenseConfigFromUI();
    const rowsUse = maybeDedupe(rows);

    if (!rowsUse.length){
      historyBody.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
      renderSummary([]);
      return;
    }

    rowsUse.forEach(r=>{
      const expUsed = computeExpenseUsed(r, cfg);
      const net = Math.max(0, (r.income||0) - expUsed - (r.deduction||0));
      const filesLinks = (r.receipts && r.receipts.length)
        ? r.receipts.map((x,i)=>`<a href="${x.webViewLink}" target="_blank" class="text-blue-600 hover:underline">‡πÑ‡∏ü‡∏•‡πå ${i+1}</a>`).join(' ¬∑ ')
        : '<span class="text-gray-400">‚Äî</span>';

      const tr = document.createElement('tr');
      tr.className='border-b';
      tr.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${r.date||''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${(r.income||0).toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap">${expUsed.toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap">${(r.deduction||0).toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap font-semibold">${net.toLocaleString('th-TH')}</td>
        <td class="px-3 py-2 whitespace-nowrap">${filesLinks}</td>
        <td class="px-3 py-2 whitespace-nowrap"><button data-del="${r.id}" class="text-red-600 hover:underline text-xs">‡∏•‡∏ö</button></td>
      `;
      historyBody.appendChild(tr);
    });

    // delete handlers
    historyBody.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
        try {
          const calcId = btn.getAttribute('data-del');
          await db.collection('users').doc(auth.currentUser.uid).collection('calculations').doc(calcId).delete();
          loadHistory();
        } catch(e){ alert(e.message); }
      });
    });

    renderSummary(rows);
  } catch(e){
    historyMsg.textContent = e.message; historyMsg.className='text-red-600';
  }
}

document.getElementById('refreshHistory').addEventListener('click', loadHistory);

// Bind method panel + dedupe
function bindMethodPanel(){
  const radios = document.querySelectorAll('input[name="sumExpenseMethod"]');
  const cfgBox = document.getElementById('sumLumpsumConfig');
  const dedupe = document.getElementById('dedupeToggle');
  function reRender(){ if (lastRows.length){ loadHistory(); } }
  radios.forEach(r=> r.addEventListener('change', ()=>{
    const v = (document.querySelector('input[name="sumExpenseMethod"]:checked')||{}).value;
    if (v==='lumpsum') cfgBox.classList.remove('hidden'); else cfgBox.classList.add('hidden');
    reRender();
  }));
  document.getElementById('sumLumpsumPercent')?.addEventListener('input', reRender);
  document.getElementById('sumLumpsumCap')?.addEventListener('input', reRender);
  dedupe.addEventListener('change', reRender);
}
window.addEventListener('load', bindMethodPanel);

/* ========= Export CSV ========= */
async function exportHistoryCSV() {
  try {
    const rows = await fetchAllCalculations();
    const cfg = getExpenseConfigFromUI();
    const rowsUse = maybeDedupe(rows);
    const meta = cfg.method==='lumpsum' ? `‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ = ‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢ (${cfg.percent||0}%${cfg.cap?` ‡πÄ‡∏û‡∏î‡∏≤‡∏ô ${cfg.cap}`:''})` : '‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ = ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á';
    const header = ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ','‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì','‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô','‡∏™‡∏∏‡∏ó‡∏ò‡∏¥(‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)','‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à(‡∏•‡∏¥‡∏á‡∏Å‡πå)'];
    const lines = [`"${meta}"`, header.join(',')];
    rowsUse.forEach(r => {
      const expUsed = computeExpenseUsed(r, cfg);
      const net = Math.max(0, (r.income||0) - expUsed - (r.deduction||0));
      const links = r.receipts.map((x,i) => x.webViewLink||'').join(' | ');
      lines.push([
        `"${r.date||''}"`,
        r.income||0,
        expUsed,
        r.deduction||0,
        net,
        `"${links}"`
      ].join(','));
    });
    const csv = '\ufeff' + lines.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'taxonline_history.csv'; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { alert(e.message || e); }
}

/* ========= PDF (‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏™‡∏π‡∏á) ========= */
/** ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î/‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤ */
const PDF_PAGE = { unit: 'mm', format: 'a4', orientation: 'p' };
const PAGE_MARGIN_MM = 8;          // margin ‡∏£‡∏≠‡∏ö ‡πÜ
const PAGE_OVERLAP_MM = 2;         // ‡∏ã‡πâ‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ 2 ‡∏°‡∏°. ‡∏Å‡∏±‡∏ô‡∏£‡∏≠‡∏¢‡∏ï‡πà‡∏≠
const HIRES_MODE = true;           // ‡∏õ‡∏£‡∏±‡∏ö false ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á

/** ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏à‡∏≤‡∏Å section ‡πÇ‡∏î‡∏¢‡πÇ‡∏Ñ‡∏•‡∏ô DOM ‚Üí html2canvas (PNG lossless) ‚Üí ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
async function exportSectionAsPDF(sectionEl, filename){
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö jsPDF'); return; }
  if (!window.html2canvas) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö html2canvas'); return; }
  if (!sectionEl) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'); return; }

  // ‡πÇ‡∏Æ‡∏™‡∏ï‡πå clone
  let host = document.getElementById('print-clone-host');
  if (!host) {
    host = document.createElement('div');
    host.id = 'print-clone-host';
    document.body.appendChild(host);
  }
  host.innerHTML = '';

  // ‡πÇ‡∏Ñ‡∏•‡∏ô‡πÅ‡∏•‡∏∞ sanitize
  const clone = sectionEl.cloneNode(true);
  clone.classList.remove('hidden');
  clone.classList.add('print-sanitized');
  clone.style.display = 'block';
  clone.style.background = '#ffffff';

  // ‡πÄ‡∏õ‡∏¥‡∏î details ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  clone.querySelectorAll('details').forEach(d => d.open = true);

  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á target (‡∏¢‡∏¥‡πà‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‚Üí ‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡∏°)
  const TARGET_WIDTH_PX = 1340; // 1240‚Äì1440 ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
  clone.style.width = TARGET_WIDTH_PX + 'px';

  host.appendChild(clone);

  // ‡∏£‡∏≠‡∏ü‡∏≠‡∏ô‡∏ï‡πå + layout
  if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch(_){} }
  await new Promise(r => setTimeout(r, 400));

  // ‡∏™‡πÄ‡∏Å‡∏•‡∏à‡∏≤‡∏Å DPR
  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  const scale = HIRES_MODE ? Math.min(3, dpr * 2) : Math.max(1, dpr);

  // ‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏à‡∏≠‡∏£‡πå
  const canvas = await html2canvas(clone, {
    backgroundColor: '#ffffff',
    scale,
    useCORS: true,
    allowTaint: false,
    logging: false,
    windowWidth: clone.scrollWidth,
    windowHeight: clone.scrollHeight,
    foreignObjectRendering: false,
    letterRendering: true
  });

  if (!canvas || !canvas.width || !canvas.height) {
    alert('‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
  const pdf = new jsPDF(PDF_PAGE);
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const contentW = pageW - (PAGE_MARGIN_MM * 2);
  const contentH = pageH - (PAGE_MARGIN_MM * 2);

  const imgPxW = canvas.width;
  const imgPxH = canvas.height;
  const ratio = imgPxW / imgPxH;
  const renderW = contentW;
  const renderH = renderW / ratio;
  const pxPerMm = imgPxW / renderW;
  const pagePxH = contentH * pxPerMm;
  const overlapPx = PAGE_OVERLAP_MM * pxPerMm;

  // ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏°‡∏µ overlap)
  let sY = 0; let page = 0;
  while (sY < imgPxH) {
    const sliceH = Math.min(pagePxH, imgPxH - sY);
    const slice = document.createElement('canvas');
    slice.width = imgPxW;
    slice.height = sliceH;
    const ctx = slice.getContext('2d');
    ctx.drawImage(canvas, 0, sY, imgPxW, sliceH, 0, 0, imgPxW, sliceH);

    // ‡πÉ‡∏ä‡πâ PNG (lossless) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏°
    const imgData = slice.toDataURL('image/png');

    if (page > 0) pdf.addPage();
    pdf.addImage(imgData, 'PNG', PAGE_MARGIN_MM, PAGE_MARGIN_MM, renderW, (sliceH/pxPerMm), undefined, 'FAST');

    sY += (sliceH - overlapPx);
    page += 1;
  }

  pdf.save(filename);
  host.innerHTML = '';
}

/* ‡∏õ‡∏∏‡πà‡∏°: ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô PDF (‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏™‡∏π‡∏á) */
async function exportHistoryPDF_HiRes() {
  if (!auth || !auth.currentUser) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
  await loadHistory(); // ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô DOM ‡∏Å‡πà‡∏≠‡∏ô
  const src = document.getElementById('historySection');
  await exportSectionAsPDF(src, 'taxonline_summary.pdf');
}

/* ‡∏õ‡∏∏‡πà‡∏°: ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô PDF (‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏™‡∏π‡∏á) */
async function exportGuidePDF() {
  const src = document.getElementById('guideSection');
  await exportSectionAsPDF(src, 'TaxOnline_User_Guide.pdf');
}

async function openDriveFolder() {
  try {
    const { webViewLink } = await getOrCreateDriveFolder();
    if (!webViewLink) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå'); return; }
    window.open(webViewLink, '_blank');
  } catch(e) { alert(e.message || e); }
}

document.getElementById('downloadCsvBtn')?.addEventListener('click', exportHistoryCSV);
/* ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Hi-Res ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô */
document.getElementById('downloadPdfBtn')?.addEventListener('click', exportHistoryPDF_HiRes);
document.getElementById('openDriveFolderBtn')?.addEventListener('click', openDriveFolder);
document.getElementById('downloadGuidePdfBtn')?.addEventListener('click', exportGuidePDF);

/* ========= BOOT ========= */
(async function boot(){
  const diag = [];
  try{
    await waitForFirebase(10000);
    diag.push('[OK] Firebase SDK loaded');

    const firebaseConfig = {
      apiKey: "AIzaSyBl-j4STHVQ80VNM6mPl80-55BHk4nEyZk",
      authDomain: "tax-online-6afdd.firebaseapp.com",
      projectId: "tax-online-6afdd",
      appId: "1:959276043439:web:f358ce055687efea5d185a"
      // storageBucket: "your-bucket.appspot.com"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    diag.push('[OK] Firebase initialized, Firestore & Auth ready]');

    // Auth flows
    const loginForm = document.getElementById('loginForm');
    const authMessage = document.getElementById('authMessage');
    loginForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(()=>showOnly('calculator'))
        .catch(err=>authMessage.textContent=err.message);
    });

    const signupForm = document.getElementById('signupForm');
    signupForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const firstName = document.getElementById('signupFirstName').value.trim();
      const lastName = document.getElementById('signupLastName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      if (!firstName || !lastName || !email || !password) { authMessage.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return; }
      auth.createUserWithEmailAndPassword(email, password)
        .then(cred=>{
          const user=cred.user;
          return user.updateProfile({ displayName: `${firstName} ${lastName}` })
            .then(()=> db.collection('users').doc(user.uid).set({
              uid:user.uid, firstName, lastName, email, phone:'', address:'', createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, {merge:true}));
        })
        .then(()=>{ showOnly('profile'); loadProfile(); })
        .catch(err=> authMessage.textContent=err.message );
    });

    document.getElementById('googleSignInBtn').addEventListener('click', ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(async res=>{
          const user = res.user;
          const docRef = db.collection('users').doc(user.uid);
          const snap = await docRef.get();
          if (!snap.exists) {
            const [firstName, ...rest] = (user.displayName||'').split(' ');
            await docRef.set({
              uid:user.uid,
              firstName:firstName||'',
              lastName:(rest||[]).join(' ')||'',
              email:user.email||'',
              phone:'', address:'',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, {merge:true});
          }
          showOnly('calculator');
        })
        .catch(err=> authMessage.textContent=err.message );
    });

    logoutBtn.addEventListener('click', ()=> auth.signOut());

    auth.onAuthStateChanged((user)=>{
      if (user) {
        userGreeting.classList.remove('hidden');
        userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${user.displayName || user.email}`;
        loginNav.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
      } else {
        userGreeting.classList.add('hidden');
        loginNav.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        showOnly('welcome');
      }
    });

    // Diagnostics
    const checks = [
      ['window.firebase', !!window.firebase],
      ['firebase.apps.length', firebase.apps && firebase.apps.length>0],
      ['firebase.auth', !!firebase.auth],
      ['firebase.firestore', !!firebase.firestore],
      ['Chart', !!window.Chart],
      ['jsPDF', !!(window.jspdf && window.jspdf.jsPDF)],
      ['GIS (google.accounts)', !!(window.google && google.accounts)],
      ['html2canvas', !!window.html2canvas]
    ];
    checks.forEach(([k,v])=> diag.push(`${v?'[OK]':'[X]'} ${k}`));
    showDiag(diag);
  }catch(err){
    console.error(err);
    showDiag(['[X] boot failed', String(err)]);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: '+ err.message);
  }
})();
</script>

</body>
</html>
